<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é ç´„ç®¡ç†å¾Œå°</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .table-responsive {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #555;
        }
        tr:hover {
            background-color: #fcfcfc;
        }
        .btn-cancel {
            background-color: #ff4d4f;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
            margin-left: 5px;
        }
        .btn-cancel:hover {
            background-color: #d9363e;
        }
        .btn-edit {
            background-color: #1890ff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .btn-edit:hover {
            background-color: #096dd9;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #888;
        }
        .empty {
            text-align: center;
            padding: 30px;
            color: #999;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“… é ç´„ç®¡ç†å¾Œå°</h1>
        <div class="table-responsive">
            <table id="bookingTable">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>æ™‚é–“</th>
                        <th>æ‰‹æ©Ÿè™Ÿç¢¼</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="bookingList">
                    <!-- é ç´„åˆ—è¡¨å°‡å‹•æ…‹æ’å…¥é€™è£¡ -->
                </tbody>
            </table>
        </div>
        <div id="status" class="loading">è¼‰å…¥ä¸­...</div>
    </div>

    <script>
        // âš ï¸ è«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨åœ¨ Vercel è¨­å®šçš„ ADMIN_SECRET
        const ADMIN_SECRET = 'MyBeautyShop_2026_Boss_Only!'; 
        const API_URL = '/api/admin-manage?secret=' + ADMIN_SECRET;

        const bookingList = document.getElementById('bookingList');
        const statusDiv = document.getElementById('status');

        // æ ¼å¼åŒ–æ—¥æœŸ (YYYY-MM-DD)
        function formatDate(dateStr) {
            return dateStr; // ç°¡å–®å›å‚³ï¼Œå¯è¦–éœ€æ±‚ç¾åŒ–
        }

        // è¼‰å…¥é ç´„åˆ—è¡¨
        async function loadBookings() {
            statusDiv.textContent = 'è¼‰å…¥ä¸­...';
            bookingList.innerHTML = '';

            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    if (response.status === 401) throw new Error('å¯†é‘°éŒ¯èª¤ (Unauthorized)');
                    throw new Error('ç„¡æ³•è®€å–è³‡æ–™');
                }

                const bookings = await response.json();

                if (bookings.length === 0) {
                    statusDiv.innerHTML = '<div class="empty">ç›®å‰æ²’æœ‰æœªä¾†çš„é ç´„</div>';
                    return;
                }

                statusDiv.style.display = 'none';

                bookings.forEach(booking => {
                    // è§£æ message JSON å­—ä¸²
                    let details = {};
                    try {
                        details = typeof booking.message === 'string' ? JSON.parse(booking.message) : booking.message;
                    } catch (e) {
                        details = { phone: 'è§£æéŒ¯èª¤', date: '?', time: '?' };
                    }

                    // å¦‚æœè³‡æ–™åº«æœ¬èº«æœ‰ date/time æ¬„ä½ï¼Œå„ªå…ˆä½¿ç”¨ï¼›å¦å‰‡ä½¿ç”¨ message è£¡çš„
                    const date = booking.date || details.date || 'æœªçŸ¥';
                    const time = booking.time || details.time || 'æœªçŸ¥';
                    const phone = booking.phone || details.phone || 'æœªçŸ¥';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${date}</td>
                        <td>${time}</td>
                        <td>${phone}</td>
                        <td>
                            <button class="btn-edit" onclick="editBooking(${booking.id}, '${date}', '${time}')">ç·¨è¼¯</button>
                            <button class="btn-cancel" onclick="cancelBooking(${booking.id})">å–æ¶ˆé ç´„</button>
                        </td>
                    `;
                    bookingList.appendChild(tr);
                });

            } catch (error) {
                console.error('Load Error:', error);
                statusDiv.textContent = `éŒ¯èª¤ï¼š${error.message}ã€‚è«‹ç¢ºèªå¯†ç¢¼æ˜¯å¦æ­£ç¢ºã€‚`;
                statusDiv.style.color = 'red';
            }
        }

        // ä¿®æ”¹é ç´„
        async function editBooking(id, oldDate, oldTime) {
            // 1. ç²å–æ–°è³‡æ–™
            const newDate = prompt('è«‹è¼¸å…¥æ–°çš„æ—¥æœŸ (YYYY-MM-DD):', oldDate);
            if (!newDate) return; // ä½¿ç”¨è€…æŒ‰å–æ¶ˆ

            const newTime = prompt('è«‹è¼¸å…¥æ–°çš„æ™‚é–“ (HH:mm):', oldTime);
            if (!newTime) return; // ä½¿ç”¨è€…æŒ‰å–æ¶ˆ

            // ç°¡å–®é©—è­‰æ ¼å¼ (å¯é¸)
            if (!/^\d{4}-\d{2}-\d{2}$/.test(newDate) || !/^\d{2}:\d{2}$/.test(newTime)) {
                alert('æ ¼å¼éŒ¯èª¤ï¼æ—¥æœŸè«‹ç”¨ YYYY-MM-DDï¼Œæ™‚é–“è«‹ç”¨ HH:mm');
                return;
            }

            statusDiv.textContent = 'è™•ç†ä¸­ï¼Œè«‹ç¨å€™... (æ­£åœ¨æª¢æŸ¥æ’æœŸ)';
            statusDiv.style.display = 'block';

            try {
                // 2. ç™¼é€è«‹æ±‚
                const response = await fetch(API_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        appointment_id: id, 
                        new_date: newDate, 
                        new_time: newTime 
                    })
                });

                const result = await response.json();

                // 3. è™•ç†å›æ‡‰
                if (response.status === 200) {
                    alert('âœ… ' + (result.message || 'ä¿®æ”¹æˆåŠŸï¼'));
                    loadBookings(); // åˆ·æ–°åˆ—è¡¨
                } else if (response.status === 409) {
                    alert('âŒ ä¿®æ”¹å¤±æ•—ï¼š' + (result.message || 'è©²æ™‚æ®µå·²è¢«ä½”ç”¨ï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚é–“ã€‚'));
                    statusDiv.style.display = 'none';
                } else {
                    throw new Error(result.error || result.message || 'ä¿®æ”¹å¤±æ•—');
                }

            } catch (error) {
                console.error('Edit Error:', error);
                alert('âŒ ç³»çµ±éŒ¯èª¤ï¼š' + error.message);
                statusDiv.style.display = 'none';
            }
        }

        // å–æ¶ˆé ç´„
        async function cancelBooking(id) {
            if (!confirm('ç¢ºå®šè¦å–æ¶ˆé€™ç­†é ç´„å—ï¼Ÿ\né€™æœƒåŒæ™‚åˆªé™¤ Google æ—¥æ›†ä¸Šçš„è¡Œç¨‹ï¼')) {
                return;
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appointment_id: id })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || result.details || 'åˆªé™¤å¤±æ•—');
                }

                alert('âœ… ' + (result.message || 'é ç´„å·²å–æ¶ˆ'));
                loadBookings(); // é‡æ–°æ•´ç†åˆ—è¡¨

            } catch (error) {
                console.error('Cancel Error:', error);
                alert('âŒ å–æ¶ˆå¤±æ•—ï¼š' + error.message);
            }
        }

        // åˆå§‹åŒ–
        if (ADMIN_SECRET === 'CHANGE_ME_PLEASE') {
            statusDiv.textContent = 'âš ï¸ è«‹å…ˆç·¨è¼¯åŸå§‹ç¢¼ï¼Œè¨­å®š ADMIN_SECRET';
            statusDiv.style.color = 'orange';
        } else {
            loadBookings();
        }
    </script>
</body>
</html>
