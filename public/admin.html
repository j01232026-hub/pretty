<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é ç´„ç®¡ç†å¾Œå°</title>
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f5f7fa;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1200px; /* Widen for chat interface */
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        h2 {
            color: #2c3e50;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 40px;
        }
        .table-responsive {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #555;
        }
        tr:hover {
            background-color: #fcfcfc;
        }
        .btn-cancel {
            background-color: #ff4d4f;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
            margin-left: 5px;
        }
        .btn-cancel:hover {
            background-color: #d9363e;
        }
        .btn-edit {
            background-color: #1890ff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        .btn-edit:hover {
            background-color: #096dd9;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #888;
        }
        .empty {
            text-align: center;
            padding: 30px;
            color: #999;
            font-style: italic;
        }

        /* Chat Interface Styles */
        .chat-layout {
            display: flex;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }
        .user-list {
            width: 250px;
            background: #f8f9fa;
            border-right: 1px solid #ddd;
            overflow-y: auto;
        }
        .user-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        .user-item:hover {
            background: #e6f7ff;
        }
        .user-item.active {
            background: #1890ff;
            color: white;
        }
        .user-id {
            font-weight: bold;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .last-msg {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .user-item.active .last-msg {
            color: #e6f7ff;
        }
        .chat-window {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
        }
        .chat-header {
            padding: 10px 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            font-weight: bold;
        }
        .messages-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f5f7fa;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .message {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.4;
            position: relative;
        }
        .message.received {
            align-self: flex-start;
            background: white;
            border: 1px solid #ddd;
            border-bottom-left-radius: 2px;
        }
        .message.sent {
            align-self: flex-end;
            background: #1890ff;
            color: white;
            border-bottom-right-radius: 2px;
        }
        .msg-time {
            font-size: 10px;
            margin-top: 4px;
            opacity: 0.7;
            text-align: right;
        }
        .input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #ddd;
            display: flex;
            gap: 10px;
        }
        .input-area textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: none;
            height: 40px;
            font-family: inherit;
        }
        .input-area button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        .input-area button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“… é ç´„ç®¡ç†å¾Œå°</h1>
        <div class="table-responsive">
            <table id="bookingTable">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>æ™‚é–“</th>
                        <th>æ‰‹æ©Ÿè™Ÿç¢¼</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="bookingList">
                    <!-- é ç´„åˆ—è¡¨å°‡å‹•æ…‹æ’å…¥é€™è£¡ -->
                </tbody>
            </table>
        </div>
        <div id="status" class="loading">è¼‰å…¥ä¸­...</div>

        <h2>ğŸ’¬ å®¢æœå°è©±ç®¡ç†</h2>
        <div class="chat-layout">
            <div class="user-list" id="userList">
                <div class="loading">è¼‰å…¥ç”¨æˆ¶ä¸­...</div>
            </div>
            <div class="chat-window">
                <div class="chat-header" id="chatHeader">è«‹é¸æ“‡å°è©±</div>
                <div class="messages-area" id="messagesArea">
                    <!-- Messages will appear here -->
                </div>
                <div class="input-area">
                    <textarea id="msgInput" placeholder="è¼¸å…¥è¨Šæ¯..." disabled></textarea>
                    <button id="sendBtn" onclick="sendAdminMessage()" disabled>å‚³é€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // âš ï¸ è«‹åœ¨æ­¤è™•å¡«å…¥æ‚¨åœ¨ Vercel è¨­å®šçš„ ADMIN_SECRET
        const ADMIN_SECRET = 'MyBeautyShop_2026_Boss_Only!'; 
        const API_URL = '/api/admin-manage?secret=' + ADMIN_SECRET;
        
        // Chat Variables
        let supabaseClient = null;
        let currentChatUser = null;
        let chatSubscription = null;
        
        // Notification Sound
        const notificationAudio = new Audio('/notification.wav');
        function playNotification() {
            notificationAudio.play().catch(e => console.log('Audio play blocked:', e));
        }

        const bookingList = document.getElementById('bookingList');
        const statusDiv = document.getElementById('status');

        // æ ¼å¼åŒ–æ—¥æœŸ (YYYY-MM-DD)
        function formatDate(dateStr) {
            return dateStr; // ç°¡å–®å›å‚³ï¼Œå¯è¦–éœ€æ±‚ç¾åŒ–
        }

        // è¼‰å…¥é ç´„åˆ—è¡¨
        async function loadBookings() {
            statusDiv.textContent = 'è¼‰å…¥ä¸­...';
            bookingList.innerHTML = '';

            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    if (response.status === 401) throw new Error('å¯†é‘°éŒ¯èª¤ (Unauthorized)');
                    throw new Error('ç„¡æ³•è®€å–è³‡æ–™');
                }

                const bookings = await response.json();

                if (bookings.length === 0) {
                    statusDiv.innerHTML = '<div class="empty">ç›®å‰æ²’æœ‰æœªä¾†çš„é ç´„</div>';
                    return;
                }

                statusDiv.style.display = 'none';

                bookings.forEach(booking => {
                    // è§£æ message JSON å­—ä¸²
                    let details = {};
                    try {
                        details = typeof booking.message === 'string' ? JSON.parse(booking.message) : booking.message;
                    } catch (e) {
                        details = { phone: 'è§£æéŒ¯èª¤', date: '?', time: '?' };
                    }

                    // å¦‚æœè³‡æ–™åº«æœ¬èº«æœ‰ date/time æ¬„ä½ï¼Œå„ªå…ˆä½¿ç”¨ï¼›å¦å‰‡ä½¿ç”¨ message è£¡çš„
                    const date = booking.date || details.date || 'æœªçŸ¥';
                    const time = booking.time || details.time || 'æœªçŸ¥';
                    const phone = booking.phone || details.phone || 'æœªçŸ¥';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${date}</td>
                        <td>${time}</td>
                        <td>${phone}</td>
                        <td>
                            <button class="btn-edit" onclick="editBooking(${booking.id}, '${date}', '${time}')">ç·¨è¼¯</button>
                            <button class="btn-cancel" onclick="cancelBooking(${booking.id})">å–æ¶ˆé ç´„</button>
                        </td>
                    `;
                    bookingList.appendChild(tr);
                });

            } catch (error) {
                console.error('Load Error:', error);
                statusDiv.textContent = `éŒ¯èª¤ï¼š${error.message}ã€‚è«‹ç¢ºèªå¯†ç¢¼æ˜¯å¦æ­£ç¢ºã€‚`;
                statusDiv.style.color = 'red';
            }
        }

        // ä¿®æ”¹é ç´„
        async function editBooking(id, oldDate, oldTime) {
            // 1. ç²å–æ–°è³‡æ–™
            const newDate = prompt('è«‹è¼¸å…¥æ–°çš„æ—¥æœŸ (YYYY-MM-DD):', oldDate);
            if (!newDate) return; // ä½¿ç”¨è€…æŒ‰å–æ¶ˆ

            const newStartTime = prompt('è«‹è¼¸å…¥æ–°çš„é–‹å§‹æ™‚é–“ (HH:mm):', oldTime);
            if (!newStartTime) return; // ä½¿ç”¨è€…æŒ‰å–æ¶ˆ

            // è¨ˆç®—é è¨­çµæŸæ™‚é–“ (é–‹å§‹æ™‚é–“ + 1å°æ™‚)
            let defaultEndTime = '';
            try {
                // å˜—è©¦å¾è¼¸å…¥çš„é–‹å§‹æ™‚é–“è¨ˆç®—é è¨­çµæŸæ™‚é–“
                const [h, m] = newStartTime.split(':').map(Number);
                const d = new Date();
                d.setHours(h + 1);
                d.setMinutes(m);
                defaultEndTime = `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
            } catch (e) {
                // è¨ˆç®—å¤±æ•—å°±ç•™ç©º
            }

            const newEndTime = prompt('è«‹è¼¸å…¥æ–°çš„çµæŸæ™‚é–“ (HH:mm):', defaultEndTime);
            if (!newEndTime) return; // ä½¿ç”¨è€…æŒ‰å–æ¶ˆ

            // ç°¡å–®é©—è­‰æ ¼å¼ (å¯é¸)
            if (!/^\d{4}-\d{2}-\d{2}$/.test(newDate) || !/^\d{2}:\d{2}$/.test(newStartTime) || !/^\d{2}:\d{2}$/.test(newEndTime)) {
                alert('æ ¼å¼éŒ¯èª¤ï¼æ—¥æœŸè«‹ç”¨ YYYY-MM-DDï¼Œæ™‚é–“è«‹ç”¨ HH:mm');
                return;
            }

            statusDiv.textContent = 'è™•ç†ä¸­ï¼Œè«‹ç¨å€™... (æ­£åœ¨æª¢æŸ¥æ’æœŸ)';
            statusDiv.style.display = 'block';

            try {
                // 2. ç™¼é€è«‹æ±‚
                const response = await fetch(API_URL, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        appointment_id: id, 
                        new_date: newDate, 
                        new_start_time: newStartTime,
                        new_end_time: newEndTime
                    })
                });

                const result = await response.json();

                // 3. è™•ç†å›æ‡‰
                if (response.status === 200) {
                    alert('âœ… ' + (result.message || 'ä¿®æ”¹æˆåŠŸï¼'));
                    loadBookings(); // åˆ·æ–°åˆ—è¡¨
                } else if (response.status === 409) {
                    alert('âŒ ä¿®æ”¹å¤±æ•—ï¼š' + (result.message || 'è©²æ™‚æ®µå·²è¢«ä½”ç”¨ï¼Œè«‹é¸æ“‡å…¶ä»–æ™‚é–“ã€‚'));
                    statusDiv.style.display = 'none';
                } else {
                    throw new Error(result.error || result.message || 'ä¿®æ”¹å¤±æ•—');
                }

            } catch (error) {
                console.error('Edit Error:', error);
                alert('âŒ ç³»çµ±éŒ¯èª¤ï¼š' + error.message);
                statusDiv.style.display = 'none';
            }
        }

        // å–æ¶ˆé ç´„
        async function cancelBooking(id) {
            if (!confirm('ç¢ºå®šè¦å–æ¶ˆé€™ç­†é ç´„å—ï¼Ÿ\né€™æœƒåŒæ™‚åˆªé™¤ Google æ—¥æ›†ä¸Šçš„è¡Œç¨‹ï¼')) {
                return;
            }

            try {
                const response = await fetch(API_URL, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ appointment_id: id })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || result.details || 'åˆªé™¤å¤±æ•—');
                }

                alert('âœ… ' + (result.message || 'é ç´„å·²å–æ¶ˆ'));
                loadBookings(); // é‡æ–°æ•´ç†åˆ—è¡¨

            } catch (error) {
                console.error('Cancel Error:', error);
                alert('âŒ å–æ¶ˆå¤±æ•—ï¼š' + error.message);
            }
        }

        // åˆå§‹åŒ– Chat System
        async function initChatSystem() {
            try {
                await initSupabase();
                await fetchChatUsers();
                
                // Realtime subscription for User List (New users or new messages)
                if (supabaseClient) {
                    supabaseClient.channel('public:messages_list')
                        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
                            // Play sound if message is from a user (not ADMIN)
                            if (payload.new.sender_id !== 'ADMIN') {
                                playNotification();
                            }
                            // Refresh list when any new message arrives (simple approach)
                            fetchChatUsers(); 
                            // If we are chatting with someone, the message will also be handled by that specific subscription
                        })
                        .subscribe();
                }
            } catch (e) {
                console.error('Chat Init Error:', e);
                document.getElementById('userList').innerHTML = '<div class="error">è¼‰å…¥å¤±æ•—</div>';
            }
        }

        // 1. Initialize Supabase
        async function initSupabase() {
            const res = await fetch('/api/config');
            const config = await res.json();
            if (window.supabase) {
                supabaseClient = window.supabase.createClient(config.supabaseUrl, config.supabaseKey);
            }
        }

        // 2. Fetch Chat Users
        async function fetchChatUsers() {
            if (!supabaseClient) return;
            
            // Fetch last 500 messages to extract users
            const { data: messages, error } = await supabaseClient
                .from('messages')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(500);

            if (error) {
                console.error('Fetch Users Error:', error);
                return;
            }

            // Extract unique users
            const userMap = new Map();
            messages.forEach(msg => {
                const otherId = msg.sender_id === 'ADMIN' ? msg.receiver_id : msg.sender_id;
                if (otherId === 'ADMIN') return; 
                
                if (!userMap.has(otherId)) {
                    userMap.set(otherId, {
                        userId: otherId,
                        lastMsg: msg.content,
                        time: new Date(msg.created_at),
                        displayName: null,
                        customName: null
                    });
                }
            });

            // Fetch Profiles
            const userIds = Array.from(userMap.keys());
            if (userIds.length > 0) {
                const { data: profiles, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .in('user_id', userIds);
                
                if (profiles) {
                    profiles.forEach(p => {
                        if (userMap.has(p.user_id)) {
                            const u = userMap.get(p.user_id);
                            u.displayName = p.display_name;
                            u.customName = p.custom_name;
                        }
                    });
                }
            }

            const users = Array.from(userMap.values());
            renderUserList(users);
        }

        // Render User List
        function renderUserList(users) {
            const listDiv = document.getElementById('userList');
            // Store previous scroll position if needed, but for now simple innerHTML
            
            if (users.length === 0) {
                listDiv.innerHTML = '<div class="empty">å°šç„¡å°è©±</div>';
                return;
            }

            let html = '';
            users.forEach(u => {
                const name = u.customName || u.displayName || u.userId;
                const activeClass = currentChatUser === u.userId ? 'active' : '';
                // Truncate ID if it's showing raw ID
                const displayId = u.userId.length > 10 ? u.userId.substr(0, 8) + '...' : u.userId;
                
                html += `
                    <div class="user-item ${activeClass}" onclick="selectUser('${u.userId}')">
                        <div class="user-id">${name}</div>
                        ${(u.customName || u.displayName) ? `<div style="font-size:10px; opacity:0.7">${displayId}</div>` : ''}
                        <div class="last-msg">${escapeHtml(u.lastMsg)}</div>
                    </div>
                `;
            });
            listDiv.innerHTML = html;
        }

        function escapeHtml(text) {
             if (!text) return '';
             return text.replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;");
        }

        // 3. Select User & Load Chat
        async function selectUser(userId) {
            currentChatUser = userId;
            
            // Get user info for header
            let displayName = userId;
            let customName = '';
            
            if (supabaseClient) {
                const { data } = await supabaseClient.from('profiles').select('*').eq('user_id', userId).single();
                if (data) {
                    displayName = data.display_name || userId;
                    customName = data.custom_name || '';
                }
            }

            const showName = customName || displayName;

            const header = document.getElementById('chatHeader');
            header.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span>èˆ‡ <b>${escapeHtml(showName)}</b> çš„å°è©±</span>
                    <button onclick="promptEditName('${userId}', '${escapeHtml(customName)}')" style="font-size:12px; padding:4px 8px; background:#fff; border:1px solid #ccc; border-radius:4px; cursor:pointer; color:#333;">
                        âœï¸ ä¿®æ”¹å‚™è¨»
                    </button>
                </div>
            `;

            document.getElementById('msgInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            
            // Highlight active user
            fetchChatUsers(); // Re-render to update active class

            // Load History
            const { data: messages, error } = await supabaseClient
                .from('messages')
                .select('*')
                .or(`and(sender_id.eq.${userId},receiver_id.eq.ADMIN),and(sender_id.eq.ADMIN,receiver_id.eq.${userId})`)
                .order('created_at', { ascending: true });

            const msgArea = document.getElementById('messagesArea');
            msgArea.innerHTML = '';

            if (messages) {
                messages.forEach(msg => appendAdminMessage(msg));
                msgArea.scrollTop = msgArea.scrollHeight;
            }

            // Subscribe to this specific chat
            if (chatSubscription) supabaseClient.removeChannel(chatSubscription);
            
            chatSubscription = supabaseClient.channel(`chat:${userId}`)
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
                    const newMsg = payload.new;
                    if (
                        (newMsg.sender_id === userId && newMsg.receiver_id === 'ADMIN') ||
                        (newMsg.sender_id === 'ADMIN' && newMsg.receiver_id === userId)
                    ) {
                        appendAdminMessage(newMsg);
                        msgArea.scrollTop = msgArea.scrollHeight;
                    }
                })
                .subscribe();
        }

        async function promptEditName(userId, currentCustom) {
            const newName = prompt('è«‹è¼¸å…¥å‚™è¨»åç¨± (ç•™ç©ºå‰‡ç§»é™¤å‚™è¨»):', currentCustom);
            if (newName === null) return; // Cancelled
            
            if (supabaseClient) {
                // Fetch current profile first to preserve display_name
                const { data } = await supabaseClient.from('profiles').select('*').eq('user_id', userId).single();
                
                const updateData = { 
                    user_id: userId, 
                    custom_name: newName || null,
                    last_seen_at: new Date().toISOString()
                };
                
                if (data) {
                    updateData.display_name = data.display_name;
                }
                
                const { error } = await supabaseClient.from('profiles').upsert(updateData);
                
                if (error) {
                    alert('æ›´æ–°å¤±æ•—: ' + error.message);
                } else {
                    fetchChatUsers(); // Refresh list
                    selectUser(userId); // Refresh header
                }
            }
        }

        // Append Message to Chat Window
        function appendAdminMessage(msg) {
            const area = document.getElementById('messagesArea');
            const div = document.createElement('div');
            const isMe = msg.sender_id === 'ADMIN';
            
            div.className = `message ${isMe ? 'sent' : 'received'}`;
            div.innerHTML = `
                ${msg.content}
                <div class="msg-time">${new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            `;
            area.appendChild(div);
        }

        // 4. Send Message
        async function sendAdminMessage() {
            if (!currentChatUser) return;
            const input = document.getElementById('msgInput');
            const content = input.value.trim();
            if (!content) return;

            input.value = '';
            
            try {
                const res = await fetch('/api/send-message', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'x-admin-secret': ADMIN_SECRET // Authenticate as Admin
                    },
                    body: JSON.stringify({
                        content: content,
                        sender_id: 'ADMIN',
                        receiver_id: currentChatUser
                    })
                });

                if (!res.ok) throw new Error('Send Failed');
                // Message will appear via Realtime subscription

            } catch (e) {
                alert('ç™¼é€å¤±æ•—: ' + e.message);
                input.value = content;
            }
        }

        // åˆå§‹åŒ–
        if (ADMIN_SECRET === 'CHANGE_ME_PLEASE') {
            statusDiv.textContent = 'âš ï¸ è«‹å…ˆç·¨è¼¯åŸå§‹ç¢¼ï¼Œè¨­å®š ADMIN_SECRET';
            statusDiv.style.color = 'orange';
        } else {
            loadBookings();
            initChatSystem();
        }
    </script>
</body>
</html>
