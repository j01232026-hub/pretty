<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é ç´„æœå‹™</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
            background-color: #f5f5f5;
        }
        /* ... existing styles ... */
        .debug-box {
            background: #333;
            color: #0f0;
            padding: 10px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 4px;
            word-break: break-all;
            display: block; /* é è¨­é¡¯ç¤ºï¼Œæ–¹ä¾¿é™¤éŒ¯ */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>é ç´„æœå‹™</h1>
        <form id="bookingForm">
            <!-- ... form fields ... -->
            <div class="form-group">
                <label for="date">æ—¥æœŸ</label>
                <input type="date" id="date" required>
            </div>
            
            <div class="form-group">
                <label for="time">æ™‚é–“</label>
                <select id="time" required>
                    <option value="">è«‹é¸æ“‡æ™‚é–“</option>
                    <option value="10:00">10:00</option>
                    <option value="11:00">11:00</option>
                    <option value="13:00">13:00</option>
                    <option value="14:00">14:00</option>
                    <option value="15:00">15:00</option>
                    <option value="16:00">16:00</option>
                </select>
            </div>

            <div class="form-group">
                <label for="phone">æ‰‹æ©Ÿè™Ÿç¢¼</label>
                <input type="tel" id="phone" placeholder="0912345678" pattern="[0-9]{10}" required>
            </div>

            <button type="submit" id="submitBtn" disabled>è¼‰å…¥ä¸­...</button>
        </form>
        <div id="status"></div>
        
        <!-- é™¤éŒ¯è¨Šæ¯å€ -->
        <div id="debugLog" class="debug-box">ç³»çµ±åˆå§‹åŒ–ä¸­...</div>
    </div>

    <!-- è¼‰å…¥ LINE LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        // TODO: è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ LIFF ID
        const LIFF_ID = '2009027968-7nFLpFJt';

        const submitBtn = document.getElementById('submitBtn');
        const statusDiv = document.getElementById('status');
        const form = document.getElementById('bookingForm');
        const debugEl = document.getElementById('debugLog');

        // é™¤éŒ¯æ—¥èªŒåŠŸèƒ½
        function log(msg, isError = false) {
            console.log(msg);
            const time = new Date().toLocaleTimeString();
            const color = isError ? 'red' : '#0f0';
            debugEl.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
        }

        window.onerror = function(msg, url, line) {
            log(`å…¨åŸŸéŒ¯èª¤: ${msg} (è¡Œè™Ÿ:${line})`, true);
            return false;
        };

        // åˆå§‹åŒ– LIFF
        async function initializeLiff() {
            try {
                log(`é–‹å§‹åˆå§‹åŒ– LIFF ID: ${LIFF_ID}`);
                submitBtn.textContent = 'é€£æ¥ LINE ä¸­...';
                
                // è¨­å®š 10 ç§’è¶…æ™‚ (æ”¾å¯¬ä¸€é»)
                const initPromise = liff.init({ liffId: LIFF_ID });
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('é€£ç·šé€¾æ™‚ (Timeout 10s)')), 10000)
                );

                await Promise.race([initPromise, timeoutPromise]);
                log('LIFF åˆå§‹åŒ–æˆåŠŸ');
                log(`InClient: ${liff.isInClient()}, LoggedIn: ${liff.isLoggedIn()}`);
                
                // 1. æª¢æŸ¥æ˜¯å¦åœ¨ LINE App å…§éƒ¨é–‹å•Ÿ
                if (!liff.isInClient()) {
                    log('åµæ¸¬åˆ°å¤–éƒ¨ç€è¦½å™¨ (æˆ–é LIFF æ¨¡å¼)');
                    
                    // éš±è—è¡¨å–®ï¼Œé¿å…èª¤ç”¨
                    form.style.display = 'none';
                    
                    statusDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <h2 style="color: #d32f2f;">âš ï¸ é–‹å•Ÿæ–¹å¼éŒ¯èª¤</h2>
                            <p style="color: #555; line-height: 1.6;">
                                æ‚¨ç›®å‰æ˜¯ç›´æ¥é–‹å•Ÿç¶²é ï¼Œå°è‡´ç„¡æ³•é€£æ¥ LINE èŠå¤©å®¤ã€‚<br>
                                è«‹æ”¹ç”¨ä¸‹æ–¹çš„ <strong>LIFF å°ˆç”¨é€£çµ</strong> é–‹å•Ÿã€‚
                            </p>
                            <a href="https://liff.line.me/${LIFF_ID}" 
                               style="display: inline-block; margin-top: 15px; padding: 15px 30px; background-color: #06c755; color: white; text-decoration: none; border-radius: 30px; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                ğŸš€ é»æ­¤æ­£ç¢ºé–‹å•Ÿé ç´„é é¢
                            </a>
                            <p style="margin-top: 20px; font-size: 12px; color: #999;">
                                (è«‹ç›´æ¥é»æ“Šä¸Šæ–¹æŒ‰éˆ•ï¼Œæˆ–å°‡é€£çµè²¼åˆ° LINE èŠå¤©å®¤ä¸­é»æ“Š)
                            </p>
                        </div>
                    `;
                    return; // åœæ­¢å¾ŒçºŒåˆå§‹åŒ–
                }

                // 2. ç™»å…¥æª¢æŸ¥
                if (!liff.isLoggedIn()) {
                    log('å°šæœªç™»å…¥ï¼ŒåŸ·è¡Œ login()...');
                    submitBtn.textContent = 'ç™»å…¥ä¸­...';
                    liff.login(); // é€™è£¡æœƒè·³è½‰
                    return;
                }

                // 3. æ¬Šé™æª¢æŸ¥
                log('é–‹å§‹æª¢æŸ¥æ¬Šé™...');
                const context = liff.getContext();
                log(`Context Type: ${context?.type}`);
                
                try {
                    const permissionStatus = await liff.permission.query('chat_message.write');
                    log(`æ¬Šé™ç‹€æ…‹: ${permissionStatus.state}`);
                    
                    if (permissionStatus.state !== 'granted') {
                        log('æ¬Šé™æœªæˆæ¬Šï¼Œé¡¯ç¤ºæ‰‹å‹•æŒ‰éˆ•');
                        statusDiv.innerHTML = 'âš ï¸ ç¼ºå°‘ç™¼é€è¨Šæ¯æ¬Šé™<br><button id="authBtn" style="margin-top:10px;padding:5px 10px;">é»æ­¤é–‹å•Ÿæ¬Šé™</button>';
                        statusDiv.classList.add('error');
                        
                        document.getElementById('authBtn').addEventListener('click', () => {
                            log('ä½¿ç”¨è€…é»æ“Šæˆæ¬ŠæŒ‰éˆ•');
                            liff.login({ scope: 'chat_message.write' });
                        });
                    }
                } catch (permError) {
                    log(`æ¬Šé™æª¢æŸ¥ç•¥é: ${permError.message}`);
                }

                // åˆå§‹åŒ–å®Œæˆ
                submitBtn.disabled = false;
                submitBtn.textContent = 'é€å‡ºé ç´„';
                log('ç³»çµ±æº–å‚™å°±ç·’');
                
                // è‡ªå‹•å¡«å…¥æ—¥æœŸ
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('date').min = today;

            } catch (error) {
                log(`åˆå§‹åŒ–åš´é‡éŒ¯èª¤: ${error.message}`, true);
                log(`Stack: ${error.stack}`, true);
                statusDiv.textContent = 'ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æˆªåœ–æ­¤ç•«é¢å›å ±';
                statusDiv.classList.add('error');
                submitBtn.textContent = 'ç™¼ç”ŸéŒ¯èª¤';
            }
        }


        // è™•ç†è¡¨å–®é€å‡º
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;
            const phone = document.getElementById('phone').value;

            // æº–å‚™è¦å‚³é€çš„ JSON è³‡æ–™
            const bookingData = {
                action: "book",
                date: date,
                time: time,
                phone: phone
            };

            // è½‰æˆå­—ä¸²
            const messageText = JSON.stringify(bookingData);

            submitBtn.disabled = true;
            submitBtn.textContent = 'å‚³é€ä¸­...';

            try {
                // åˆ¤æ–·æ˜¯å¦å¯ä»¥ä½¿ç”¨ liff.sendMessages
                // æ¢ä»¶ï¼šåœ¨ Client å…§ ä¸” Context é¡å‹ä¸æ˜¯ none ä¸” æ¬Šé™å·²æˆæ¬Š
                const context = liff.getContext();
                const permission = await liff.permission.query('chat_message.write');
                const canSendInChat = liff.isInClient() && 
                                      context && context.type !== 'none' && 
                                      permission.state === 'granted';

                if (canSendInChat) {
                    log('å˜—è©¦ä½¿ç”¨ liff.sendMessages ç™¼é€...');
                    await liff.sendMessages([
                        {
                            type: 'text',
                            text: messageText
                        }
                    ]);
                    log('liff.sendMessages æˆåŠŸ');
                } else {
                    log(`ç„¡æ³•ä½¿ç”¨è¨Šæ¯ç™¼é€ (Context: ${context?.type}, Perm: ${permission.state})`);
                    log('æ”¹ç”¨ API ç›´æ¥å¯«å…¥è³‡æ–™åº«...');
                    
                    // å–å¾—ä½¿ç”¨è€… ID
                    const profile = await liff.getProfile().catch(e => {
                        log('ç„¡æ³•å–å¾— Profile: ' + e);
                        return null;
                    });
                    
                    // å¦‚æœç„¡æ³•å–å¾— profileï¼Œå˜—è©¦å¾ decodedIDToken æ‹¿ sub
                    const userId = profile?.userId || liff.getDecodedIDToken()?.sub;

                    if (!userId) {
                        throw new Error('ç„¡æ³•è­˜åˆ¥ä½¿ç”¨è€…èº«åˆ† (User ID)');
                    }

                    // å‘¼å«å¾Œç«¯ API
                    const response = await fetch('/api/submit', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: userId,
                            date: date,
                            time: time,
                            phone: phone
                        })
                    });

                    if (!response.ok) {
                        throw new Error('API å›å‚³éŒ¯èª¤: ' + response.status);
                    }
                    log('API å¯«å…¥æˆåŠŸ');
                }

                statusDiv.textContent = 'âœ… é ç´„è³‡æ–™å·²é€å‡ºï¼';
                statusDiv.classList.remove('error');
                statusDiv.style.color = 'green';
                
                // å»¶é²ä¸€ä¸‹è®“ä½¿ç”¨è€…çœ‹åˆ°æˆåŠŸè¨Šæ¯
                setTimeout(() => {
                    liff.closeWindow();
                }, 2000);

            } catch (error) {
                log('æµç¨‹å¤±æ•—: ' + error.message, true);
                console.error('è¨Šæ¯ç™¼é€å¤±æ•—:', error);
                
                statusDiv.textContent = 'ç™¼é€å¤±æ•—: ' + error.message;
                statusDiv.classList.add('error');
                submitBtn.disabled = false;
                submitBtn.textContent = 'é€å‡ºé ç´„';
            }
        });

        // åŸ·è¡Œåˆå§‹åŒ–
        // ç¢ºä¿åœ¨ DOM è¼‰å…¥å¾ŒåŸ·è¡Œï¼Œé›–ç„¶æ”¾åœ¨ body åº•éƒ¨é€šå¸¸æ²’å•é¡Œï¼Œä½†ç‚ºäº†ä¿éšªèµ·è¦‹
        if (LIFF_ID === 'YOUR_LIFF_ID_HERE') {
            statusDiv.textContent = 'è«‹åœ¨ç¨‹å¼ç¢¼ä¸­è¨­å®šæ­£ç¢ºçš„ LIFF ID';
            statusDiv.classList.add('error');
        } else {
            initializeLiff();
        }
    </script>
</body>
</html>
