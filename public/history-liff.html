<!DOCTYPE html>
<html class="light" lang="zh-TW">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>歷史預約紀錄</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="css/global-style.css">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#9d2bee",
                        "background-light": "#f7f6f8",
                        "background-dark": "#1a1022",
                        "accent-soft": "#e9d5ff",
                        "text-main": "#1b0d18",
                        "text-muted": "#7e22ce"
                    },
                    fontFamily: {
                        "display": ["'Noto Sans TC'", "Manrope", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "1rem",
                        "lg": "2rem",
                        "xl": "3rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        body {
            min-height: max(884px, 100dvh);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 dark:from-indigo-950 dark:via-purple-950 dark:to-pink-950 bg-fixed font-display text-[#1b0d18] dark:text-white">
    <div class="relative flex h-auto min-h-screen w-full flex-col max-w-md mx-auto overflow-x-hidden shadow-2xl bg-white/30 dark:bg-black/30 backdrop-blur-3xl border-x border-white/20">
        <!-- Header -->
        <div class="flex items-center bg-white/30 dark:bg-black/30 backdrop-blur-md p-4 pb-2 justify-between sticky top-0 z-10 border-b border-white/20">
            <div class="text-[#1b0d18] dark:text-white flex size-12 shrink-0 items-center justify-center cursor-pointer hover:bg-white/20 rounded-full transition-colors" onclick="handleBack()">
                <i class="fa-solid fa-chevron-left text-xl"></i>
            </div>
            <h2 class="text-[#1b0d18] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12 drop-shadow-sm">歷史紀錄</h2>
        </div>

        <!-- Search & Filter -->
        <div class="px-4 py-2 sticky top-14 z-10 bg-white/30 dark:bg-black/30 backdrop-blur-md border-b border-white/10">
            <div class="flex gap-2">
                    <label class="flex flex-col flex-1 h-12">
                        <div class="flex w-full flex-1 items-stretch rounded-xl h-full brand-card">
                            <div class="text-text-muted flex border-none bg-accent-soft dark:bg-white/10 items-center justify-center pl-4 rounded-l-xl">
                            <i class="fa-solid fa-magnifying-glass text-gray-500"></i>
                        </div>
                        <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-text-main dark:text-white focus:outline-0 focus:ring-0 border-none bg-accent-soft dark:bg-white/10 placeholder:text-gray-500 px-4 rounded-l-none border-l-0 pl-2 text-base font-normal" placeholder="搜尋紀錄" value=""/>
                    </div>
                </label>
                <button class="flex size-12 items-center justify-center bg-accent-soft dark:bg-white/10 rounded-xl text-gray-500 hover:bg-accent-soft/80 transition-colors">
                    <i class="fa-solid fa-sliders"></i>
                </button>
            </div>
        </div>
        
        <!-- Chips -->
        <div class="flex gap-3 px-4 py-3 overflow-x-auto hide-scrollbar brand-card mx-4 mb-4">
            <button class="flex h-9 shrink-0 items-center justify-center gap-x-2 rounded-full bg-primary text-white px-4">
                <p class="text-sm font-medium">全部</p>
            </button>
            <button class="flex h-9 shrink-0 items-center justify-center gap-x-2 rounded-full bg-accent-soft dark:bg-white/10 px-4">
                <p class="text-[#1b0d18] dark:text-white text-sm font-medium">最近30天</p>
                <i class="fa-solid fa-chevron-down text-sm"></i>
            </button>
            <button class="flex h-9 shrink-0 items-center justify-center gap-x-2 rounded-full bg-accent-soft dark:bg-white/10 px-4">
                <p class="text-[#1b0d18] dark:text-white text-sm font-medium">服務項目</p>
                <i class="fa-solid fa-chevron-down text-sm"></i>
            </button>
        </div>

        <!-- Appointment List Content -->
        <div class="flex-1 flex flex-col gap-4 p-4" id="history-container">
            <!-- Loading State -->
            <div id="loading-spinner" class="flex flex-col items-center justify-center py-10">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary"></div>
                <p class="mt-4 text-gray-500 text-sm">載入歷史紀錄中...</p>
            </div>
            <!-- Dynamic Content -->
        </div>
        
        <!-- Bottom Navigation Spacer -->
        <div class="h-20"></div>

        <!-- Template for History Card -->
        <template id="history-card-template">
            <div class="flex flex-col items-stretch justify-start rounded-xl shadow-lg bg-white/60 dark:bg-black/60 backdrop-blur-md overflow-hidden border border-white/20 mb-4 history-card brand-card">
                <div class="flex p-4 gap-4">
                    <div class="w-24 h-24 bg-center bg-no-repeat bg-cover rounded-lg shrink-0 bg-gray-200" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCMkStRV5clh0STCcvx_LWc9Vpp_VBOkSH_dWLFtqa_sDAyQmRXubyOk5l8Vr9e18QjvMAaGqZ3ete56yz2J5TaYDSUDg4KoVadJig1m9hZX9mtZ_Tz7BD4Qay9WaQ1SDOEQq7BWAt7zynSJ10s6c7SUeQHXA735GkRYttcb9hRiJw9MIkUMhNSGZP5mVphsrJmc82Hx5j-FDHlUzqU1I4UUEiSY488Pc0O_ES_tGYwo9q8VIcT7CFDgwb0dKscUUwvh3PxL2rhDn3O");'></div>
                    <div class="flex flex-1 flex-col justify-between">
                        <div>
                            <p class="text-[#1b0d18] dark:text-white text-lg font-bold leading-tight stylist-name drop-shadow-sm">設計師名稱</p>
                            <p class="text-purple-600 dark:text-purple-400 text-sm font-normal mt-1 service-info">一般服務 • YYYY-MM-DD</p>
                        </div>
                        <p class="text-purple-600 dark:text-purple-400 text-base font-bold price-info">NT$ 500</p>
                    </div>
                </div>
                <div class="flex px-4 pb-4 gap-3">
                    <button class="flex-1 h-10 cursor-pointer items-center justify-center rounded-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white text-sm font-bold shadow-lg shadow-purple-500/30 transition-all active:scale-[0.98] btn-rebook">
                        <i class="fa-solid fa-rotate-right mr-1"></i>
                        <span>再次預約</span>
                    </button>
                    <button class="flex-1 h-10 cursor-pointer items-center justify-center rounded-full bg-white/40 dark:bg-white/10 text-[#1b0d18] dark:text-white text-sm font-bold border border-white/20 hover:bg-white/50 transition-all active:scale-[0.98]">
                        <i class="fa-regular fa-star mr-1"></i>
                        <span>評分與評論</span>
                    </button>
                </div>
            </div>
        </template>
    </div>

    <script>
        // 優先從網址參數取得 LIFF ID (例如 ?liffId=xxx)，若無則使用預設值
        const urlParams = new URLSearchParams(window.location.search);
        // Default to the provided ID for History Page
        const LIFF_ID = urlParams.get('liffId') || '2009027968-8FTFYHCQ';
        console.log('Using LIFF ID:', LIFF_ID);
        // 你的預約頁面完整 LIFF URL，請替換為實際的 LIFF URL
        // 如果沒有，可以用 window.location.href 跳轉到相對路徑
        const BOOKING_LIFF_URL = 'https://liff.line.me/2009027968-7nFLpFJt'; 
        
        let staffMap = {}; // Map: name -> { avatar }

        window.onload = async function() {
            try {
                // Pre-fetch staff data
                await fetchStaffData();

                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                const userId = profile.userId;
                console.log('User ID:', userId);
                
                fetchHistory(userId);

            } catch (err) {
                console.error('LIFF Init Failed:', err);
                // 測試模式 fallback
                // fetchHistory('U_TEST_USER');
                document.getElementById('history-container').innerHTML = `<div class="px-4 text-center"><p class="text-red-500 font-bold mb-2">LIFF 初始化失敗</p><p class="text-xs text-gray-500 bg-gray-100 p-2 rounded text-left break-all">${err.message || JSON.stringify(err)}</p><p class="text-xs text-gray-400 mt-2">請確認此頁面網址是否已在 LINE Developers Console 註冊為 LIFF 應用程式，或者 Endpoint URL 是否正確。</p></div>`;
            }
        };

        // Fetch Staff Data
        async function fetchStaffData() {
            try {
                const res = await fetch('/api/staff');
                if (res.ok) {
                    const staffList = await res.json();
                    console.debug('Fetched staff data:', staffList);
                    staffList.forEach(s => {
                        staffMap[s.name] = s;
                    });
                    console.log('Staff data loaded:', Object.keys(staffMap).length);
                }
            } catch (e) {
                console.error('Failed to load staff data:', e);
            }
        }

        function handleBack() {
            if (liff.isInClient()) {
                liff.closeWindow();
            } else {
                window.history.back();
            }
        }

        async function fetchHistory(userId) {
            const container = document.getElementById('history-container');
            
            try {
                const res = await fetch(`/api/get-appointments?user_id=${userId}&type=history`);
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                
                renderHistory(data);

            } catch (err) {
                console.error('Fetch Error:', err);
                container.innerHTML = `<p class="text-center text-gray-500 mt-10">無法載入歷史紀錄</p>`;
            }
        }

        function renderHistory(appointments) {
            const container = document.getElementById('history-container');
            container.innerHTML = '';

            if (appointments.length === 0) {
                container.innerHTML = `
                    <div class="py-12 flex flex-col items-center justify-center text-gray-400 opacity-60">
                        <i class="fa-solid fa-clock-rotate-left text-6xl mb-4"></i>
                        <p class="text-sm">目前沒有歷史預約紀錄</p>
                    </div>
                `;
                return;
            }

            const template = document.getElementById('history-card-template');

            appointments.forEach(appt => {
                const clone = template.content.cloneNode(true);
                
                const stylistName = appt.stylist || '指定設計師';
                clone.querySelector('.stylist-name').textContent = stylistName;
                
                // Update History Avatar
                const historyAvatarEl = clone.querySelector('.bg-cover.rounded-lg.shrink-0'); 
                if (historyAvatarEl) {
                        let avatarUrl = "https://lh3.googleusercontent.com/aida-public/AB6AXuCMkStRV5clh0STCcvx_LWc9Vpp_VBOkSH_dWLFtqa_sDAyQmRXubyOk5l8Vr9e18QjvMAaGqZ3ete56yz2J5TaYDSUDg4KoVadJig1m9hZX9mtZ_Tz7BD4Qay9WaQ1SDOEQq7BWAt7zynSJ10s6c7SUeQHXA735GkRYttcb9hRiJw9MIkUMhNSGZP5mVphsrJmc82Hx5j-FDHlUzqU1I4UUEiSY488Pc0O_ES_tGYwo9q8VIcT7CFDgwb0dKscUUwvh3PxL2rhDn3O";
                        if (staffMap[stylistName] && staffMap[stylistName].avatar_url) {
                            avatarUrl = staffMap[stylistName].avatar_url;
                        }
                        historyAvatarEl.style.backgroundImage = `url("${avatarUrl}")`;
                }

                // Format Date
                let timeDisplay = appt.time;
                if (appt.endTime) {
                    timeDisplay += ` - ${appt.endTime}`;
                }
                clone.querySelector('.service-info').textContent = `一般服務 • ${appt.date} • ${timeDisplay}`;
                
                clone.querySelector('.price-info').textContent = `NT$ ${appt.price || 500}`;

                // Rebook Button
                const rebookBtn = clone.querySelector('.btn-rebook');
                rebookBtn.onclick = () => {
                    // 使用 liff.openWindow 跳轉
                    if (liff.isInClient()) {
                        liff.openWindow({
                            url: BOOKING_LIFF_URL,
                            external: false // 在 LINE 內部瀏覽器開啟
                        });
                    } else {
                        // 瀏覽器 fallback
                        window.location.href = 'booking-liff.html';
                    }
                };

                container.appendChild(clone);
            });
            
            // End of list indicator
            const endIndicator = document.createElement('div');
            endIndicator.className = 'py-8 flex flex-col items-center justify-center text-gray-400 opacity-60';
            endIndicator.innerHTML = `
                <i class="fa-solid fa-clock-rotate-left text-4xl mb-2"></i>
                <p class="text-sm">已顯示所有紀錄</p>
            `;
            container.appendChild(endIndicator);
        }
    </script>
</body>
</html>
