<!DOCTYPE html>
<html class="light" lang="zh-TW">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>預約服務</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#9d2bee",
                        "background-light": "#f7f6f8",
                        "background-dark": "#1a1022",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Manrope', sans-serif;
            min-height: max(884px, 100dvh);
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Disabled button style */
        .time-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background-color: #e5e7eb; /* gray-200 */
            color: #9ca3af; /* gray-400 */
            border-color: transparent;
        }
        .date-btn.selected {
            background-color: #9d2bee;
            color: white;
        }
        .time-btn.selected {
            background-color: #9d2bee;
            color: white;
            border-color: #9d2bee;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark text-[#160d1b] dark:text-white min-h-screen flex flex-col">
    <!-- Top Navigation Bar -->
    <header class="sticky top-0 z-50 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-md px-4 py-4 flex items-center justify-between">
        <button class="flex items-center justify-center size-10 rounded-full bg-white dark:bg-zinc-800 shadow-sm" onclick="window.history.back()">
            <span class="material-symbols-outlined text-xl">arrow_back_ios_new</span>
        </button>
        <h1 class="text-lg font-bold tracking-tight">預約服務</h1>
        <div class="size-10"></div> <!-- Spacer for symmetry -->
    </header>

    <main class="flex-1 overflow-y-auto pb-40">
        <!-- Stylist Selection Section -->
        <section class="mt-4">
            <div class="px-4 mb-2 flex justify-between items-end">
                <h3 class="text-lg font-bold tracking-tight">選擇設計師</h3>
                <span class="text-primary text-sm font-semibold">查看全部</span>
            </div>
            <div class="flex overflow-x-auto hide-scrollbar px-4 py-3 gap-5">
                <!-- Stylist Items (Names translated or kept if names) -->
                <div class="flex flex-col items-center gap-2 min-w-[72px] cursor-pointer stylist-item" onclick="selectStylist(this, 'Jessica')">
                    <div class="size-16 rounded-full p-1 border-2 border-transparent hover:border-primary transition-colors">
                        <div class="w-full h-full bg-center bg-cover rounded-full" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCL1YvZc9vWZJ9GiVuuWWM-av6u8YdeHm1Jgv8tYw8axrTwQq7ZR84wTe89nuC8A5dwR_oya7pRLN6xYwqXY8V-0NRIgWQ5hWQYbI9iVI30AvhTiRXo4NRXDFL5ZndEXlKm6RxxbKoZh000JC42yB5urx2De51L2d10BSBu_klGM0fcejTK5Q0QbbocZy6IOVWw3hV_fkczYRfPQpCjbbdHHyun9LGo16YDclE613E4Y6fLw_q4igKd9RsXCfy1sTzTNgW7Do_pC8u4");'></div>
                    </div>
                    <p class="text-[13px] font-semibold text-primary">Jessica</p>
                </div>
                <div class="flex flex-col items-center gap-2 min-w-[72px] cursor-pointer stylist-item" onclick="selectStylist(this, 'Marcus')">
                    <div class="size-16 rounded-full p-1 border-2 border-transparent hover:border-primary transition-colors">
                        <div class="w-full h-full bg-center bg-cover rounded-full" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuD1Bgy-pciGb6F31ar5s2gpzTWn22bOY2fRW7fd8slqhS4Koii6jMAOD1WPJGnWNTWGTM6ymWiIQX6kbHNdwBhtxCbdsZul7Rmrl-nP7yZRu2Lw-jtrQfaBmGrEfXeW_cezY6sNLsM8UDAYmsLuemy1La0tHrsDgIwZeWZhFHuA7_R8b_13fQIDu58plZoE38YR_PphhP3Nym8yOJwWAPraHgiaQqaIICCHIe0NKTCBEDd-DezvFkIweHudeeofobQ73QxKpyhPpSQV");'></div>
                    </div>
                    <p class="text-[13px] font-medium opacity-70">Marcus</p>
                </div>
                <div class="flex flex-col items-center gap-2 min-w-[72px] cursor-pointer stylist-item" onclick="selectStylist(this, 'Chloe')">
                    <div class="size-16 rounded-full p-1 border-2 border-transparent hover:border-primary transition-colors">
                        <div class="w-full h-full bg-center bg-cover rounded-full" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuByyRrhTtFgLxfmAJAgQUOHY6LLsJ-1O-MUUbOQtx9yw9K9nVMjrVgDP5kwtmc8dtFLZ1cZBzUkiZkP5M5z_u-Qn5lMwzdiv67q4LMYrGbSYdnufo6zhL8MBtuSzaDe5LZ8jP_0opH5wKQDHYHMNsZgQT5PhQJL0upiA9tj2J28jzWBCm8Pnw5asPjIMIrDfEfIO0U2RvoyikWBQjpkqc8p5HEPipUvXSsQ3YsYRLm_j--scQh-9XrFvKasC78S1TFTGiFAaKZnKPvr");'></div>
                    </div>
                    <p class="text-[13px] font-medium opacity-70">Chloe</p>
                </div>
                <div class="flex flex-col items-center gap-2 min-w-[72px] cursor-pointer stylist-item" onclick="selectStylist(this, 'David')">
                    <div class="size-16 rounded-full p-1 border-2 border-transparent hover:border-primary transition-colors">
                        <div class="w-full h-full bg-center bg-cover rounded-full" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBXiTocK93QgvldfhhsEWRc3e5XQi3jgZSH8v2AOXnThuxDU6miv2IEf1b01D-C_ARJfoVJmR7WalxGh6TjFCqwwAfekcBjsOqmlrs_lz4876EjDjCDnWehiFZ8a1Dr0tdGFuvrtL4WvG0Zi9GhjiIWWVd8EeguEZbXB4Nvo2l-_zS1bgx5ceW4EbrBM2TLsACFa-BrXzPKkYdXhkXuWWnGj5z2ljk_Z5emppYADMMphB4E1Ei_noU1gBiBZ5Ia4I3tkvybKB1qET5Z");'></div>
                    </div>
                    <p class="text-[13px] font-medium opacity-70">David</p>
                </div>
                <div class="flex flex-col items-center gap-2 min-w-[72px] cursor-pointer stylist-item" onclick="selectStylist(this, '不指定')">
                    <div class="size-16 rounded-full bg-primary/10 dark:bg-primary/20 flex items-center justify-center border-2 border-transparent hover:border-primary transition-colors">
                        <span class="material-symbols-outlined text-primary">group</span>
                    </div>
                    <p class="text-[13px] font-medium opacity-70">不指定</p>
                </div>
            </div>
        </section>

        <!-- Service Selection Section (New) -->
        <section class="mt-6 px-4">
            <h3 class="text-lg font-bold tracking-tight mb-4">選擇服務項目</h3>
            <div class="bg-white dark:bg-zinc-900 rounded-3xl p-5 shadow-sm border border-black/5 dark:border-white/5 text-center text-gray-500">
                (未來功能預留區)
            </div>
        </section>

        <!-- Calendar Picker Section -->
        <section class="mt-6 px-4">
            <h3 class="text-lg font-bold tracking-tight mb-4">選擇日期</h3>
            <div class="bg-white dark:bg-zinc-900 rounded-3xl p-5 shadow-sm border border-black/5 dark:border-white/5">
                <div class="flex items-center justify-between mb-6">
                    <button class="p-2" onclick="changeMonth(-1)"><span class="material-symbols-outlined">chevron_left</span></button>
                    <p class="text-base font-bold" id="currentMonthDisplay">Loading...</p>
                    <button class="p-2" onclick="changeMonth(1)"><span class="material-symbols-outlined">chevron_right</span></button>
                </div>
                <div class="grid grid-cols-7 text-center text-[12px] font-bold opacity-40 mb-2">
                    <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                </div>
                <div class="grid grid-cols-7 gap-y-1" id="calendarGrid">
                    <!-- Calendar days will be generated here -->
                </div>
            </div>
        </section>

        <!-- Time Slots Section -->
        <section class="mt-8">
            <h3 class="px-4 text-lg font-bold tracking-tight mb-4">選擇時段</h3>
            <div class="space-y-6">
                <!-- Morning (10:00 - 12:00) -->
                <div>
                    <p class="px-4 text-sm font-bold opacity-40 uppercase tracking-wider mb-3">上午時段</p>
                    <div class="flex overflow-x-auto hide-scrollbar px-4 gap-3">
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="10:00">10:00</button>
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="10:30">10:30</button>
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="11:00">11:00</button>
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="11:30">11:30</button>
                    </div>
                </div>

                <!-- Afternoon (12:00 - 18:00) -->
                <div>
                    <p class="px-4 text-sm font-bold opacity-40 uppercase tracking-wider mb-3">下午時段</p>
                    <div class="flex overflow-x-auto hide-scrollbar px-4 gap-3">
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="12:00">12:00</button>
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="12:30">12:30</button>
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="13:00">13:00</button>
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="13:30">13:30</button>
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="14:00">14:00</button>
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="14:30">14:30</button>
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="15:00">15:00</button>
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="15:30">15:30</button>
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="16:00">16:00</button>
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="16:30">16:30</button>
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="17:00">17:00</button>
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="17:30">17:30</button>
                    </div>
                </div>

                <!-- Evening (18:00 - 20:00) -->
                <div>
                    <p class="px-4 text-sm font-bold opacity-40 uppercase tracking-wider mb-3">晚上時段</p>
                    <div class="flex overflow-x-auto hide-scrollbar px-4 gap-3">
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="18:00">18:00</button>
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="18:30">18:30</button>
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="19:00">19:00</button>
                        <button class="time-btn px-6 py-3 rounded-full bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="19:30">19:30</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Phone Number Section (New) -->
        <section class="mt-8 px-4 mb-4">
             <h3 class="text-lg font-bold tracking-tight mb-2">手機號碼</h3>
             <input type="tel" id="phoneInput" placeholder="0912345678" class="w-full rounded-2xl border border-black/10 dark:border-white/10 bg-white dark:bg-zinc-900 p-4 text-lg focus:ring-primary focus:border-primary outline-none">
        </section>

    </main>

    <!-- Fixed Bottom Action Bar -->
    <footer class="fixed bottom-0 left-0 right-0 bg-white/80 dark:bg-background-dark/80 backdrop-blur-xl border-t border-black/5 dark:border-white/5 p-4 pb-8">
        <button id="confirmBtn" class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-4 rounded-full shadow-lg shadow-primary/30 flex items-center justify-center gap-2 transition-transform active:scale-[0.98]">
            <span>確認預約</span>
            <span class="material-symbols-outlined text-xl">calendar_check</span>
        </button>
    </footer>

    <script>
        // State
        let currentYear, currentMonth;
        let selectedDate = null;
        let selectedTime = null;
        let selectedStylist = '不指定';

        // Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize LIFF
            try {
                // Replace with your LIFF ID if known, otherwise it might fail or fallback
                // For now we assume standard initialization
                await liff.init({ liffId: "YOUR_LIFF_ID" }); 
                if (!liff.isLoggedIn()) {
                    liff.login();
                }
            } catch (err) {
                console.error('LIFF Init Error:', err);
                // Proceed anyway for testing in browser
            }

            // Init Calendar
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth(); // 0-indexed
            
            renderCalendar(currentYear, currentMonth);
            
            // Select Today by default
            const todayString = formatDate(today);
            selectDate(todayString);

            // Bind Time Buttons
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (e.target.disabled) return;
                    selectTime(e.target.dataset.time, e.target);
                });
            });

            // Bind Confirm Button
            document.getElementById('confirmBtn').addEventListener('click', confirmBooking);
        });

        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function renderCalendar(year, month) {
            const grid = document.getElementById('calendarGrid');
            const display = document.getElementById('currentMonthDisplay');
            grid.innerHTML = '';
            
            const monthNames = ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"];
            display.textContent = `${year}年 ${monthNames[month]}`;

            const firstDay = new Date(year, month, 1).getDay(); // 0 (Sun) - 6 (Sat)
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Padding for first row
            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            // Days
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
            
            for (let d = 1; d <= daysInMonth; d++) {
                const btn = document.createElement('button');
                btn.className = 'h-10 w-full flex items-center justify-center text-sm font-medium rounded-full transition-colors date-btn hover:bg-gray-100 dark:hover:bg-zinc-800';
                btn.textContent = d;
                
                // Construct date string YYYY-MM-DD
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                btn.dataset.date = dateStr;
                
                // Highlight today or selected
                if (isCurrentMonth && d === today.getDate()) {
                    // Default selection logic handles this via selectDate call
                }
                
                // Disable past dates
                const checkDate = new Date(year, month, d);
                checkDate.setHours(0,0,0,0);
                const todayMidnight = new Date();
                todayMidnight.setHours(0,0,0,0);
                
                if (checkDate < todayMidnight) {
                    btn.classList.add('opacity-30', 'cursor-not-allowed');
                    btn.disabled = true;
                } else {
                    btn.onclick = () => selectDate(dateStr);
                }

                grid.appendChild(btn);
            }
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar(currentYear, currentMonth);
            // Re-select date if visible? 
            // For simplicity, we keep selectedDate state but visual might be lost if changing month
            // We can check if selectedDate is in current view and highlight it
            if (selectedDate) {
                const el = document.querySelector(`button[data-date="${selectedDate}"]`);
                if (el) el.classList.add('selected');
            }
        }

        async function selectDate(dateStr) {
            selectedDate = dateStr;
            selectedTime = null; // Reset time
            
            // Visual Update
            document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('selected', 'bg-primary', 'text-white', 'font-bold'));
            const btn = document.querySelector(`button[data-date="${dateStr}"]`);
            if (btn) {
                btn.classList.add('selected', 'bg-primary', 'text-white', 'font-bold');
                btn.classList.remove('hover:bg-gray-100', 'dark:hover:bg-zinc-800');
            }

            // Reset Time Buttons
            document.querySelectorAll('.time-btn').forEach(b => {
                b.classList.remove('selected');
                b.disabled = false;
            });

            // Fetch Busy Slots
            await fetchBusySlots(dateStr);
        }

        async function fetchBusySlots(date) {
            try {
                const res = await fetch(`/api/get-busy-slots?date=${date}`);
                if (!res.ok) throw new Error('Network response was not ok');
                const busySlots = await res.json();
                
                // busySlots: [{start: 'ISO...', end: 'ISO...'}, ...]
                // Disable overlapping buttons
                const timeBtns = document.querySelectorAll('.time-btn');
                timeBtns.forEach(btn => {
                    const time = btn.dataset.time; // HH:mm
                    const slotStart = new Date(`${date}T${time}:00+08:00`);
                    // Modify: Change default duration check to 30 minutes to match slot interval
                    // This allows booking at 15:00 even if there is a booking at 15:30 (assuming 30min service)
                    const slotEnd = new Date(slotStart.getTime() + 30 * 60 * 1000); 

                    const isBusy = busySlots.some(busy => {
                        const busyStart = new Date(busy.start);
                        const busyEnd = new Date(busy.end);
                        
                        // Check overlap: Start < BusyEnd && End > BusyStart
                        return slotStart < busyEnd && slotEnd > busyStart;
                    });

                    if (isBusy) {
                        btn.disabled = true;
                    }
                });

            } catch (err) {
                console.error('Fetch Busy Slots Failed:', err);
                // Optionally alert user or just leave open
            }
        }

        function selectTime(time, btnElement) {
            selectedTime = time;
            document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('selected'));
            btnElement.classList.add('selected');
        }

        function selectStylist(el, name) {
            selectedStylist = name;
            document.querySelectorAll('.stylist-item .rounded-full').forEach(div => {
                div.classList.remove('border-primary');
                div.classList.add('border-transparent');
            });
            document.querySelectorAll('.stylist-item p').forEach(p => {
                p.classList.remove('text-primary');
                p.classList.add('opacity-70');
            });
            
            const avatar = el.querySelector('.rounded-full');
            const label = el.querySelector('p');
            avatar.classList.remove('border-transparent');
            avatar.classList.add('border-primary');
            label.classList.remove('opacity-70');
            label.classList.add('text-primary');
        }

        async function confirmBooking() {
            const phone = document.getElementById('phoneInput').value.trim();
            
            if (!selectedDate) return alert('請選擇日期');
            if (!selectedTime) return alert('請選擇時段');
            if (!phone) return alert('請輸入手機號碼');

            const payload = {
                type: 'booking_request',
                data: {
                    stylist: selectedStylist,
                    date: selectedDate,
                    time: selectedTime,
                    phone: phone
                }
            };
            
            // Format message for LINE
            // We usually send a text message that the webhook parses, or a specific payload if using LIFF to trigger bot
            // Here we'll send a structured text for the bot to parse, or a JSON string if the bot supports it
            // Based on user context, Supabase uses JSON in message.
            // Let's send a JSON string.
            const messageText = JSON.stringify(payload.data);

            try {
                if (liff.isInClient()) {
                    await liff.sendMessages([{
                        type: 'text',
                        text: messageText
                    }]);
                    liff.closeWindow();
                } else {
                    // Fallback for browser testing
                    console.log('Booking Payload:', payload);
                    alert('預約資料已送出 (測試模式):\n' + messageText);
                }
            } catch (err) {
                console.error('LIFF Send Error:', err);
                alert('發送失敗: ' + err.message);
            }
        }
    </script>
</body>
</html>