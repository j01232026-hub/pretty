<!DOCTYPE html>
<html class="light" lang="zh-TW">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>預約服務</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200;300;400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style-enhancement.css">
    <link rel="stylesheet" href="css/global-style.css">
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="js/custom-modal.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#9d2bee",
                        "background-light": "#f7f6f8",
                        "background-dark": "#1a1022",
                    },
                    fontFamily: {
                        "display": ["'Noto Sans TC'", "Manrope", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Manrope', sans-serif;
            min-height: max(884px, 100dvh);
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Disabled button style */
        .time-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            background-color: #e5e7eb; /* gray-200 */
            color: #9ca3af; /* gray-400 */
            border-color: transparent;
        }
        .date-btn.selected {
            background-color: #9d2bee;
            color: white;
        }
        .time-btn.selected {
            background-color: #9d2bee;
            color: white;
            border-color: #9d2bee;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 dark:from-indigo-950 dark:via-purple-950 dark:to-pink-950 bg-fixed font-display text-[#1b0d18] dark:text-white min-h-screen flex flex-col">
    <div class="relative flex h-auto min-h-screen w-full flex-col max-w-md mx-auto overflow-x-hidden shadow-2xl bg-white/30 dark:bg-black/30 backdrop-blur-3xl border-x border-white/20">
    <!-- Top Navigation Bar -->
    <header class="sticky top-0 z-50 bg-white/70 dark:bg-black/70 backdrop-blur-md px-4 py-4 flex items-center justify-between border-b border-white/20">
        <button class="flex items-center justify-center size-10 rounded-full bg-white/50 dark:bg-zinc-800/50 hover:bg-white/80 transition-colors shadow-sm text-gray-700 dark:text-gray-200" onclick="handleBack()">
            <i class="fa-solid fa-chevron-left text-xl"></i>
        </button>
        <h1 class="text-lg font-bold tracking-tight text-[#1b0d18] dark:text-white">預約服務</h1>
        <div class="size-10"></div> <!-- Spacer for symmetry -->
    </header>

    <main class="flex-1 overflow-y-auto pb-40">
        <!-- Stylist Selection Section -->
        <section class="mt-4">
            <div class="px-4 mb-2 flex justify-between items-end">
                <h3 class="text-lg font-bold tracking-tight">選擇設計師</h3>
            </div>
            <div class="flex px-4 py-3 gap-5 overflow-x-auto hide-scrollbar" id="stylistContainer">
                <div class="text-sm text-gray-400 p-2">載入設計師中...</div>
            </div>
        </section>

        <!-- Service Selection Section (New) -->
        <section class="mt-6 px-4">
            <h3 class="text-lg font-bold tracking-tight mb-4">選擇服務項目</h3>
            <div class="bg-white dark:bg-zinc-900 rounded-3xl p-5 shadow-sm border border-black/5 dark:border-white/5 text-center text-gray-500">
                (未來功能預留區)
            </div>
        </section>

        <!-- Calendar Picker Section -->
        <section class="mt-6 px-4">
            <h3 class="text-lg font-bold tracking-tight mb-4">選擇日期</h3>
            <div class="bg-white/60 dark:bg-zinc-900/60 backdrop-blur-md rounded-3xl p-5 shadow-sm border border-white/20">
                <div class="flex items-center justify-between mb-6">
                    <button class="p-2 hover:bg-white/20 rounded-full transition-colors" onclick="changeMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                    <p class="text-base font-bold text-[#1b0d18] dark:text-white" id="currentMonthDisplay">Loading...</p>
                    <button class="p-2 hover:bg-white/20 rounded-full transition-colors" onclick="changeMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
                <div class="grid grid-cols-7 text-center text-[12px] font-bold opacity-40 mb-2">
                    <div>日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div>六</div>
                </div>
                <div class="grid grid-cols-7 gap-y-1" id="calendarGrid">
                    <!-- Calendar days will be generated here -->
                </div>
            </div>
        </section>

        <!-- Time Slots Section -->
        <section class="mt-8">
            <h3 class="px-4 text-lg font-bold tracking-tight mb-4">選擇時段 <span class="text-sm font-normal text-gray-500 dark:text-gray-400">(每選擇一個時段為30分鐘)</span></h3>
            <div class="space-y-6">
                <!-- Morning (10:00 - 12:00) -->
                <div>
                    <p class="px-4 text-sm font-bold opacity-40 uppercase tracking-wider mb-3">上午時段</p>
                    <div class="grid grid-cols-4 px-4 gap-3">
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="10:00">10:00</button>
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="10:30">10:30</button>
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="11:00">11:00</button>
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="11:30">11:30</button>
                    </div>
                </div>

                <!-- Afternoon (12:00 - 18:00) -->
                <div>
                    <p class="px-4 text-sm font-bold opacity-40 uppercase tracking-wider mb-3">下午時段</p>
                    <div class="grid grid-cols-4 px-4 gap-3">
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="12:00">12:00</button>
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="12:30">12:30</button>
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="13:00">13:00</button>
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="13:30">13:30</button>
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="14:00">14:00</button>
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="14:30">14:30</button>
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="15:00">15:00</button>
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="15:30">15:30</button>
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="16:00">16:00</button>
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="16:30">16:30</button>
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="17:00">17:00</button>
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="17:30">17:30</button>
                    </div>
                </div>

                <!-- Evening (18:00 - 20:00) -->
                <div>
                    <p class="px-4 text-sm font-bold opacity-40 uppercase tracking-wider mb-3">晚上時段</p>
                    <div class="grid grid-cols-4 px-4 gap-3">
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="18:00">18:00</button>
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="18:30">18:30</button>
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="19:00">19:00</button>
                        <button class="time-btn px-4 py-3 rounded-xl bg-white dark:bg-zinc-900 border border-black/5 dark:border-white/5 whitespace-nowrap text-sm font-semibold transition-colors" data-time="19:30">19:30</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Contact Info Section -->
        <section class="mt-8 px-4 mb-4">
            <div class="bg-white/40 dark:bg-black/40 backdrop-blur-md rounded-3xl p-5 shadow-lg border border-white/20">
                <div class="flex gap-4">
                    <div class="flex-1">
                        <h3 class="text-lg font-bold tracking-tight mb-2 drop-shadow-sm">姓名</h3>
                        <input type="text" id="nameInput" placeholder="您的姓名" class="w-full rounded-2xl border border-white/30 bg-white/50 dark:bg-black/50 p-4 text-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none shadow-inner backdrop-blur-sm transition-all">
                    </div>
                    <div class="flex-1">
                        <h3 class="text-lg font-bold tracking-tight mb-2 drop-shadow-sm">手機號碼</h3>
                        <input type="tel" id="phoneInput" placeholder="0912345678" class="w-full rounded-2xl border border-white/30 bg-white/50 dark:bg-black/50 p-4 text-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent outline-none shadow-inner backdrop-blur-sm transition-all">
                    </div>
                </div>
            </div>
        </section>

    </main>
    </div> <!-- End of relative container -->

    <!-- Fixed Bottom Action Bar -->
    <footer class="fixed bottom-0 left-0 right-0 bg-white/60 dark:bg-black/60 backdrop-blur-xl border-t border-white/20 p-4 pb-8 z-50 max-w-md mx-auto">
        <button id="confirmBtn" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-4 rounded-full shadow-lg shadow-purple-500/30 flex items-center justify-center gap-2 transition-transform active:scale-[0.98]">
            <span>確認預約</span>
            <i class="fa-regular fa-calendar-check text-xl"></i>
        </button>
    </footer>

    <!-- Confirmation Modal Removed (Replaced by CustomModal) -->

    <script>
        // State
        let currentYear, currentMonth;
        let selectedDate = null;
        let selectedTimes = new Set();
        let selectedStylist = null; // Changed from hardcoded default

        function handleBack() {
            try {
                if (liff && liff.isInClient()) {
                    liff.closeWindow();
                } else {
                    window.history.back();
                }
            } catch (e) {
                console.error('Back button error:', e);
                window.history.back();
            }
        }

        // Fetch Stylists
        async function fetchStylists() {
            const container = document.getElementById('stylistContainer');
            try {
                const res = await fetch('/api/staff');
                if (!res.ok) throw new Error('Failed to fetch stylists');
                const staffList = await res.json();

                container.innerHTML = '';

                if (staffList.length === 0) {
                    container.innerHTML = '<div class="text-sm text-gray-400 p-2">目前無設計師可選</div>';
                    return;
                }

                staffList.forEach((staff, index) => {
                    // If no stylist selected yet, select the first one by default? 
                    // Or let user choose. Let's default to first one if null.
                    if (!selectedStylist && index === 0) {
                        selectedStylist = staff.name;
                    }

                    const isSelected = (selectedStylist === staff.name);
                    const activeClass = isSelected ? 'border-primary' : 'border-transparent';
                    const opacityClass = isSelected ? 'opacity-100 font-bold text-primary' : 'opacity-70';
                    
                    const el = document.createElement('div');
                    el.className = 'stylist-item flex flex-col items-center gap-2 min-w-[72px] cursor-pointer group';
                    el.onclick = () => selectStylistUI(el, staff.name);
                    
                    // Use a default avatar if none provided
                    const avatarUrl = staff.avatar_url || 'https://www.w3schools.com/howto/img_avatar.png';
                    
                    el.innerHTML = `
                        <div class="size-16 rounded-full p-1 border-2 ${activeClass} transition-all duration-300 img-wrapper">
                            <div class="w-full h-full bg-center bg-cover rounded-full shadow-sm" style="background-image: url('${avatarUrl}')"></div>
                        </div>
                        <p class="text-[13px] font-medium ${opacityClass} transition-colors name-text text-center truncate w-full">${staff.name}</p>
                    `;
                    
                    container.appendChild(el);
                });

            } catch (e) {
                console.error(e);
                container.innerHTML = '<div class="text-sm text-red-400 p-2">載入失敗</div>';
            }
        }

        function selectStylistUI(el, name) {
            selectedStylist = name;
            
            // Reset all
            document.querySelectorAll('.stylist-item .img-wrapper').forEach(div => {
                div.classList.remove('border-primary');
                div.classList.add('border-transparent');
            });
            document.querySelectorAll('.stylist-item .name-text').forEach(p => {
                p.classList.remove('opacity-100', 'font-bold', 'text-primary');
                p.classList.add('opacity-70');
            });

            // Set active
            const wrapper = el.querySelector('.img-wrapper');
            const text = el.querySelector('.name-text');
            
            wrapper.classList.remove('border-transparent');
            wrapper.classList.add('border-primary');
            
            text.classList.remove('opacity-70');
            text.classList.add('opacity-100', 'font-bold', 'text-primary');
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const stylist = urlParams.get('stylist');
            if (stylist) {
                selectedStylist = stylist;
            }

            // Load Stylists
            await fetchStylists();

            // Initialize LIFF
            try {
                // Use the project's LIFF ID
                // 優先從網址參數取得 LIFF ID (例如 ?liffId=xxx)，若無則使用預設值
                const urlParams = new URLSearchParams(window.location.search);
                const STORE_ID = urlParams.get('store_id');
                let LIFF_ID = urlParams.get('liffId') || '2009027968-7nFLpFJt';

                if (STORE_ID) {
                    try {
                        const res = await fetch(`/api/get-salon-info?store_id=${STORE_ID}`);
                        if (res.ok) {
                            const info = await res.json();
                            if (info.liff_id) {
                                LIFF_ID = info.liff_id;
                                console.log('Using Dynamic LIFF ID:', LIFF_ID);
                            }
                        }
                    } catch (e) { console.error(e); }
                }

                await liff.init({ liffId: LIFF_ID });  
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    // Get User Profile for Name
                    const profile = await liff.getProfile();
                    const nameInput = document.getElementById('nameInput');
                    if (nameInput && profile.displayName) {
                        nameInput.value = profile.displayName;
                    }
                }
            } catch (err) {
                console.error('LIFF Init Error:', err);
                // Proceed anyway for testing in browser
            }

            // Init Calendar
            const today = new Date();
            currentYear = today.getFullYear();
            currentMonth = today.getMonth(); // 0-indexed
            
            renderCalendar(currentYear, currentMonth);
            
            // Select Today by default
            const todayString = formatDate(today);
            selectDate(todayString);

            // Bind Time Buttons
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (e.target.disabled) return;
                    selectTime(e.target.dataset.time, e.target);
                });
            });

            // Bind Confirm Button
            document.getElementById('confirmBtn').addEventListener('click', confirmBooking);
        });

        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function renderCalendar(year, month) {
            const grid = document.getElementById('calendarGrid');
            const display = document.getElementById('currentMonthDisplay');
            grid.innerHTML = '';
            
            const monthNames = ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"];
            display.textContent = `${year}年 ${monthNames[month]}`;

            const firstDay = new Date(year, month, 1).getDay(); // 0 (Sun) - 6 (Sat)
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Padding for first row
            for (let i = 0; i < firstDay; i++) {
                grid.appendChild(document.createElement('div'));
            }

            // Days
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
            
            for (let d = 1; d <= daysInMonth; d++) {
                const btn = document.createElement('button');
                btn.className = 'h-10 w-full flex items-center justify-center text-sm font-medium rounded-full transition-colors date-btn hover:bg-gray-100 dark:hover:bg-zinc-800';
                btn.textContent = d;
                
                // Construct date string YYYY-MM-DD
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                btn.dataset.date = dateStr;
                
                // Highlight today or selected
                if (isCurrentMonth && d === today.getDate()) {
                    // Default selection logic handles this via selectDate call
                }
                
                // Disable past dates
                const checkDate = new Date(year, month, d);
                checkDate.setHours(0,0,0,0);
                const todayMidnight = new Date();
                todayMidnight.setHours(0,0,0,0);
                
                if (checkDate < todayMidnight) {
                    btn.classList.add('opacity-30', 'cursor-not-allowed');
                    btn.disabled = true;
                } else {
                    btn.onclick = () => selectDate(dateStr);
                }

                grid.appendChild(btn);
            }
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar(currentYear, currentMonth);
            // Re-select date if visible? 
            // For simplicity, we keep selectedDate state but visual might be lost if changing month
            // We can check if selectedDate is in current view and highlight it
            if (selectedDate) {
                const el = document.querySelector(`button[data-date="${selectedDate}"]`);
                if (el) el.classList.add('selected');
            }
        }

        async function selectDate(dateStr) {
            selectedDate = dateStr;
            selectedTimes.clear(); // Reset times
            
            // Visual Update
            document.querySelectorAll('.date-btn').forEach(b => b.classList.remove('selected', 'bg-primary', 'text-white', 'font-bold'));
            const btn = document.querySelector(`button[data-date="${dateStr}"]`);
            if (btn) {
                btn.classList.add('selected', 'bg-primary', 'text-white', 'font-bold');
                btn.classList.remove('hover:bg-gray-100', 'dark:hover:bg-zinc-800');
            }

            // Reset Time Buttons
            document.querySelectorAll('.time-btn').forEach(b => {
                b.classList.remove('selected', 'opacity-30', 'cursor-not-allowed');
                b.disabled = false;
            });

            // Fetch Busy Slots
            await fetchBusySlots(dateStr);
            
            // Logic 1 & 2: Disable past times and enforce 30-min buffer
            updateTimeSlotAvailability(dateStr);
        }

        function updateTimeSlotAvailability(dateStr) {
            const now = new Date();
            // Parse dateStr (YYYY-MM-DD) as local time to avoid UTC issues
            const [y, m, d] = dateStr.split('-').map(Number);
            const selectedDateObj = new Date(y, m - 1, d);
            
            // Check if it's the same day
            const isToday = selectedDateObj.getFullYear() === now.getFullYear() &&
                            selectedDateObj.getMonth() === now.getMonth() &&
                            selectedDateObj.getDate() === now.getDate();
            
            if (isToday) {
                const bufferTime = new Date(now.getTime() + 30 * 60 * 1000); // Now + 30 mins
                
                document.querySelectorAll('.time-btn').forEach(btn => {
                    if (btn.disabled) return; // Already disabled by busy slots
                    
                    const [h, min] = btn.dataset.time.split(':').map(Number);
                    const slotTime = new Date(selectedDateObj);
                    slotTime.setHours(h, min, 0, 0);
                    
                    if (slotTime < bufferTime) {
                        btn.disabled = true;
                        // CSS :disabled selector handles styling (opacity-30, cursor-not-allowed)
                    }
                });
            }
        }

        async function fetchBusySlots(date) {
            try {
                const res = await fetch(`/api/get-busy-slots?date=${date}`);
                if (!res.ok) throw new Error('Network response was not ok');
                const busySlots = await res.json();
                
                // busySlots: [{start: 'ISO...', end: 'ISO...'}, ...]
                // Disable overlapping buttons
                const timeBtns = document.querySelectorAll('.time-btn');
                timeBtns.forEach(btn => {
                    const time = btn.dataset.time; // HH:mm
                    const slotStart = new Date(`${date}T${time}:00+08:00`);
                    // Modify: Change default duration check to 30 minutes to match slot interval
                    // This allows booking at 15:00 even if there is a booking at 15:30 (assuming 30min service)
                    const slotEnd = new Date(slotStart.getTime() + 30 * 60 * 1000); 

                    const isBusy = busySlots.some(busy => {
                        const busyStart = new Date(busy.start);
                        const busyEnd = new Date(busy.end);
                        
                        // Check overlap: Start < BusyEnd && End > BusyStart
                        return slotStart < busyEnd && slotEnd > busyStart;
                    });

                    if (isBusy) {
                        btn.disabled = true;
                    }
                });

            } catch (err) {
                console.error('Fetch Busy Slots Failed:', err);
                // Optionally alert user or just leave open
            }
        }

        function selectTime(time, btnElement) {
            // Logic 3: Contiguity Constraint
            if (selectedTimes.has(time)) {
                // Deselect logic (Allow standard toggle off)
                selectedTimes.delete(time);
                btnElement.classList.remove('selected');
            } else {
                // Select logic
                if (selectedTimes.size > 0) {
                    // Convert HH:MM to minutes for comparison
                    const toMinutes = (t) => {
                        const [h, m] = t.split(':').map(Number);
                        return h * 60 + m;
                    };
                    
                    const currentMinutes = toMinutes(time);
                    const sortedSelected = Array.from(selectedTimes).map(toMinutes).sort((a, b) => a - b);
                    const lastSelected = sortedSelected[sortedSelected.length - 1];
                    
                    // Check if current is exactly 30 mins after the last selected
                    // "只能往後不能往前" & "必須是連續時段"
                    if (currentMinutes !== lastSelected + 30) {
                        CustomModal.alert('提示', '必須要連續時段才可預約');
                        return;
                    }
                }
                
                selectedTimes.add(time);
                btnElement.classList.add('selected');
            }
        }

        function selectStylist(el, name) {
            selectedStylist = name;
            document.querySelectorAll('.stylist-item .rounded-full').forEach(div => {
                div.classList.remove('border-primary');
                div.classList.add('border-transparent');
            });
            document.querySelectorAll('.stylist-item p').forEach(p => {
                p.classList.remove('text-primary');
                p.classList.add('opacity-70');
            });
            
            const avatar = el.querySelector('.rounded-full');
            const label = el.querySelector('p');
            avatar.classList.remove('border-transparent');
            avatar.classList.add('border-primary');
            label.classList.remove('opacity-70');
            label.classList.add('text-primary');
        }

        async function confirmBooking() {
            const name = document.getElementById('nameInput').value.trim();
            const phone = document.getElementById('phoneInput').value.trim();
            
            if (!selectedStylist) return CustomModal.alert('提示', '請選擇設計師 (若列表未載入請重新整理網頁)');
            if (!selectedDate) return CustomModal.alert('提示', '請選擇日期');
            if (selectedTimes.size === 0) return CustomModal.alert('提示', '請選擇至少一個時段');
            if (!name) return CustomModal.alert('提示', '請輸入姓名');
            if (!phone) return CustomModal.alert('提示', '請輸入手機號碼');

            const timeString = formatSelectedTimes();
            
            const htmlContent = `
                <div class="text-left space-y-3 text-base">
                    <div class="flex justify-between border-b border-gray-100 dark:border-white/5 pb-2">
                        <span class="text-gray-500">設計師</span>
                        <span class="font-bold text-gray-900 dark:text-gray-100">${selectedStylist}</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-100 dark:border-white/5 pb-2">
                        <span class="text-gray-500">日期</span>
                        <span class="font-bold text-gray-900 dark:text-gray-100">${selectedDate}</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-100 dark:border-white/5 pb-2">
                        <span class="text-gray-500">時間</span>
                        <span class="font-bold text-gray-900 dark:text-gray-100">${timeString}</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-100 dark:border-white/5 pb-2">
                        <span class="text-gray-500">姓名</span>
                        <span class="font-bold text-gray-900 dark:text-gray-100">${name}</span>
                    </div>
                    <div class="flex justify-between border-b border-gray-100 dark:border-white/5 pb-2">
                        <span class="text-gray-500">手機</span>
                        <span class="font-bold text-gray-900 dark:text-gray-100">${phone}</span>
                    </div>
                </div>
                <p class="text-center text-lg font-bold mt-6">確定預約嗎？</p>
            `;

            const result = await CustomModal.confirm('預約確認', htmlContent, '確定送出預約資訊', '取消');
            if (result) {
                await submitBooking();
            }
        }

        function formatSelectedTimes() {
            const times = Array.from(selectedTimes);
            if (times.length === 0) return '';
            
            const timeToMin = (t) => {
                const [h, m] = t.split(':').map(Number);
                return h * 60 + m;
            };
            
            const minToTime = (min) => {
                const h = Math.floor(min / 60);
                const m = min % 60;
                return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            };

            const sortedMins = times.map(timeToMin).sort((a, b) => a - b);
            
            let ranges = [];
            let start = sortedMins[0];
            let end = start + 30; 
            
            for (let i = 1; i < sortedMins.length; i++) {
                if (sortedMins[i] === end) {
                    end += 30;
                } else {
                    ranges.push(`${minToTime(start)}-${minToTime(end)}`);
                    start = sortedMins[i];
                    end = start + 30;
                }
            }
            ranges.push(`${minToTime(start)}-${minToTime(end)}`);
            
            return ranges.join(', ');
        }

        async function submitBooking() {
            const name = document.getElementById('nameInput').value.trim();
            const phone = document.getElementById('phoneInput').value.trim();
            const timeString = formatSelectedTimes();
            
            // Calculate Start and End Time for API
            const times = Array.from(selectedTimes).sort();
            if (times.length === 0) return;

            const timeToMin = (t) => {
                const [h, m] = t.split(':').map(Number);
                return h * 60 + m;
            };
            const minToTime = (min) => {
                const h = Math.floor(min / 60);
                const m = min % 60;
                return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
            };

            const startTime = times[0];
            const lastTimeMin = timeToMin(times[times.length - 1]);
            const endTime = minToTime(lastTimeMin + 30); // Add 30 mins to the last slot

            // Get User ID
            let userId = 'U_GUEST';
            let pictureUrl = '';
            if (liff.isInClient() || liff.isLoggedIn()) {
                try {
                    const profile = await liff.getProfile();
                    userId = profile.userId;
                    pictureUrl = profile.pictureUrl;
                } catch (e) {
                    console.error('Get Profile Error:', e);
                }
            }
            
            try {
                const res = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId,
                        name,
                        date: selectedDate,
                        time: startTime,
                        endTime: endTime,
                        phone: phone,
                        stylist: selectedStylist,
                        pictureUrl
                    })
                });

                if (!res.ok) {
                    const errData = await res.json();
                    throw new Error(errData.message || '預約寫入失敗');
                }

                // API Success -> Send LINE Message
                if (liff.isInClient()) {
                    // 只關閉視窗，讓後端發送 Push Message
                    liff.closeWindow();
                } else {
                    await CustomModal.success('預約成功', `(測試模式)<br>設計師：${selectedStylist}<br>日期：${selectedDate}<br>時間：${timeString}<br>姓名：${name}<br>手機：${phone}`);
                    window.location.reload();
                }

            } catch (err) {
                console.error('Submit Error:', err);
                CustomModal.error('預約失敗', err.message);
            }
        }
    </script>
</body>
</html>