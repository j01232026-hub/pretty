<!DOCTYPE html>
<html class="light" lang="zh-TW">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>我的預約</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#9d2bee",
                        "background-light": "#f7f6f8",
                        "background-dark": "#1a1022",
                        "accent-soft": "#e9d5ff",
                        "text-main": "#1b0d18",
                        "text-muted": "#7e22ce"
                    },
                    fontFamily: {
                        "display": ["'Noto Sans TC'", "Manrope", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        body {
            min-height: max(884px, 100dvh);
        }
        .tab-active {
            @apply bg-white/80 dark:bg-black/60 shadow-sm text-primary font-bold backdrop-blur-sm;
        }
        .tab-inactive {
            @apply text-gray-500 dark:text-gray-400 font-medium hover:text-primary/70;
        }
        
        /* Compact Card Styles */
        .compact-appointment-card {
            @apply flex items-center bg-white dark:bg-[#2d1a29] rounded-2xl p-4 shadow-[0_4px_12px_rgba(0,0,0,0.05)] transition-all active:scale-[0.98] border border-gray-100 dark:border-white/5;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 dark:from-indigo-950 dark:via-purple-950 dark:to-pink-950 bg-fixed font-display text-[#1b0d18] dark:text-white">
    <div class="relative flex h-auto min-h-screen w-full flex-col max-w-md mx-auto overflow-x-hidden shadow-2xl bg-white/30 dark:bg-black/30 backdrop-blur-3xl border-x border-white/20">
        <!-- Header -->
        <div class="flex items-center bg-white/30 dark:bg-black/30 backdrop-blur-md p-4 pb-2 justify-between sticky top-0 z-10 border-b border-white/20">
            <div class="text-[#1b0d18] dark:text-white flex size-12 shrink-0 items-center justify-center cursor-pointer hover:bg-white/20 rounded-full transition-colors" onclick="handleBack()">
                <i class="fa-solid fa-chevron-left text-xl"></i>
            </div>
            <h2 class="text-[#1b0d18] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12 drop-shadow-sm">我的預約</h2>
        </div>

        <!-- Tabs -->
        <div class="px-4 py-2 sticky top-14 z-10 bg-white/30 dark:bg-black/30 backdrop-blur-md border-b border-white/10">
            <div class="flex p-1 bg-white/40 dark:bg-black/40 rounded-xl border border-white/20">
                <button id="tab-upcoming" class="flex-1 py-2 text-sm rounded-lg transition-all tab-active" onclick="switchTab('upcoming')">即將到來</button>
                <button id="tab-history" class="flex-1 py-2 text-sm rounded-lg transition-all tab-inactive" onclick="switchTab('history')">歷史紀錄</button>
            </div>
        </div>

        <!-- History Controls (Search & Chips) - Hidden by default -->
        <div id="history-controls" class="hidden">
            <!-- SearchBar & Filters -->
            <div class="px-4 py-2">
                <div class="flex gap-2">
                    <label class="flex flex-col flex-1 h-12">
                        <div class="flex w-full flex-1 items-stretch rounded-xl h-full">
                            <div class="text-text-muted flex border-none bg-accent-soft dark:bg-white/10 items-center justify-center pl-4 rounded-l-xl">
                                <i class="fa-solid fa-magnifying-glass text-gray-500"></i>
                            </div>
                            <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-text-main dark:text-white focus:outline-0 focus:ring-0 border-none bg-accent-soft dark:bg-white/10 placeholder:text-gray-500 px-4 rounded-l-none border-l-0 pl-2 text-base font-normal" placeholder="搜尋預約" value=""/>
                        </div>
                    </label>
                    <button class="flex size-12 items-center justify-center bg-accent-soft dark:bg-white/10 rounded-xl text-gray-500">
                        <i class="fa-solid fa-sliders"></i>
                    </button>
                </div>
            </div>
            
            <!-- Chips -->
            <div class="flex gap-3 px-4 py-3 overflow-x-auto hide-scrollbar">
                <button class="flex h-9 shrink-0 items-center justify-center gap-x-2 rounded-full bg-primary text-white px-4">
                    <p class="text-sm font-medium">全部紀錄</p>
                </button>
                <button class="flex h-9 shrink-0 items-center justify-center gap-x-2 rounded-full bg-accent-soft dark:bg-white/10 px-4">
                    <p class="text-[#1b0d18] dark:text-white text-sm font-medium">最近30天</p>
                    <i class="fa-solid fa-chevron-down text-sm"></i>
                </button>
                <button class="flex h-9 shrink-0 items-center justify-center gap-x-2 rounded-full bg-accent-soft dark:bg-white/10 px-4">
                    <p class="text-[#1b0d18] dark:text-white text-sm font-medium">服務項目</p>
                    <i class="fa-solid fa-chevron-down text-sm"></i>
                </button>
            </div>
        </div>

        <!-- Content Container -->
        <div class="flex flex-col gap-6 p-4 pb-20 min-h-[500px]" id="appointments-container">
            <!-- Loading State -->
            <div id="loading-spinner" class="flex flex-col items-center justify-center py-10">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary"></div>
                <p class="mt-4 text-gray-500 text-sm">載入預約中...</p>
            </div>
            
            <!-- Dynamic content will be injected here -->
        </div>
        
        <!-- Template for History Skeleton -->
        <template id="history-skeleton-template">
            <div class="flex flex-col items-stretch justify-start rounded-xl shadow-sm bg-white dark:bg-[#2d1a29] overflow-hidden border border-gray-100 dark:border-white/5 mb-4 animate-pulse">
                <div class="flex p-4 gap-4">
                    <div class="w-24 h-24 bg-gray-200 dark:bg-gray-700 rounded-lg shrink-0"></div>
                    <div class="flex flex-1 flex-col justify-between">
                        <div class="flex flex-col gap-2">
                            <div class="h-5 bg-gray-200 dark:bg-gray-700 rounded w-1/2"></div>
                            <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>
                        </div>
                        <div class="h-5 bg-gray-200 dark:bg-gray-700 rounded w-1/4"></div>
                    </div>
                </div>
                <div class="flex px-4 pb-4 gap-3">
                    <div class="flex-1 h-10 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
                    <div class="flex-1 h-10 bg-gray-200 dark:bg-gray-700 rounded-full"></div>
                </div>
            </div>
        </template>

        <!-- Template for Upcoming Skeleton -->
        <template id="upcoming-skeleton-template">
            <div class="animate-pulse flex flex-col gap-6">
                <!-- Hero Card Skeleton -->
                <div class="rounded-xl bg-white dark:bg-[#2d1a29] overflow-hidden shadow-[0_4px_12px_rgba(0,0,0,0.05)]">
                    <div class="aspect-video bg-gray-200 dark:bg-gray-700 w-full"></div>
                    <div class="p-6 gap-4 flex flex-col">
                        <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/4"></div>
                        <div class="h-8 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>
                        <div class="mt-4 gap-2 flex flex-col">
                             <div class="flex justify-between">
                                <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/3"></div>
                                <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/4"></div>
                             </div>
                             <div class="h-2 bg-gray-200 dark:bg-gray-700 rounded-full w-full"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Salon Info Skeleton -->
                <div>
                     <div class="h-6 bg-gray-200 dark:bg-gray-700 rounded w-1/3 mb-3"></div>
                     <div class="flex items-center gap-4 bg-white dark:bg-[#2d1a29] rounded-xl p-3 shadow-sm justify-between">
                         <div class="flex items-center gap-4 flex-1">
                             <div class="size-14 rounded-lg bg-gray-200 dark:bg-gray-700 shrink-0"></div>
                             <div class="flex flex-col gap-2 flex-1">
                                 <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded w-1/2"></div>
                                 <div class="h-3 bg-gray-200 dark:bg-gray-700 rounded w-3/4"></div>
                             </div>
                         </div>
                     </div>
                </div>
            </div>
        </template>
        
        <!-- Template for Active Appointment (Hero Card) -->
        <template id="active-card-template">
            <div class="@container">
                <!-- Status Hero Card -->
                <div class="flex flex-col items-stretch justify-start rounded-xl shadow-[0_4px_12px_rgba(0,0,0,0.05)] bg-white dark:bg-[#2d1a29] overflow-hidden mb-6">
                    <!-- Gradient Status Header -->
                    <div class="w-full bg-center bg-no-repeat aspect-video bg-cover" style="background-image: linear-gradient(135deg, #e9d5ff 0%, #9d2bee 100%);">
                        <div class="flex flex-col h-full items-center justify-center text-white text-center p-6">
                            <i class="fa-solid fa-circle-check text-5xl mb-2"></i>
                            <p class="text-3xl font-bold">已確認</p>
                        </div>
                    </div>
                    
                    <!-- Content Body -->
                    <div class="flex w-full min-w-72 grow flex-col items-stretch justify-center gap-1 py-4 px-6">
                        <div class="flex flex-col gap-4">
                            <div class="flex items-start justify-between">
                                <div class="flex flex-col">
                                    <p class="text-xs text-primary font-bold uppercase">服務項目</p>
                                    <p class="text-[#1b0d18] dark:text-white font-medium booking-service">一般服務</p>
                                    <p class="text-sm text-gray-500">30 分鐘</p>
                                </div>
                                <div class="flex flex-col items-end">
                                    <p class="text-xs text-primary font-bold uppercase text-right">時間</p>
                                    <p class="text-[#1b0d18] dark:text-white font-medium text-right date-text">YYYY-MM-DD</p>
                                    <p class="text-sm text-gray-500 text-right time-text">HH:MM</p>
                                </div>
                            </div>
                            <div class="h-px bg-gray-100 dark:bg-gray-700 w-full"></div>
                            
                            <!-- Assigned Professional (Stylist) -->
                            <div class="flex items-center gap-4">
                                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-12" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCL1YvZc9vWZJ9GiVuuWWM-av6u8YdeHm1Jgv8tYw8axrTwQq7ZR84wTe89nuC8A5dwR_oya7pRLN6xYwqXY8V-0NRIgWQ5hWQYbI9iVI30AvhTiRXo4NRXDFL5ZndEXlKm6RxxbKoZh000JC42yB5urx2De51L2d10BSBu_klGM0fcejTK5Q0QbbocZy6IOVWw3hV_fkczYRfPQpCjbbdHHyun9LGo16YDclE613E4Y6fLw_q4igKd9RsXCfy1sTzTNgW7Do_pC8u4");'></div>
                                <div class="flex flex-col">
                                    <p class="text-xs text-primary font-bold uppercase">指定設計師</p>
                                    <p class="text-[#1b0d18] dark:text-white font-medium stylist-name">設計師名稱</p>
                                    <div class="flex items-center gap-1">
                                        <i class="fa-solid fa-star text-yellow-500 text-sm"></i>
                                        <p class="text-xs text-gray-500">5.0 專業設計師</p>
                                    </div>
                                </div>
                                <button class="ml-auto flex h-9 w-9 items-center justify-center rounded-full bg-primary/10 text-primary">
                                    <i class="fa-regular fa-comment text-base"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Compact List Container (Today's Later Schedule) -->
                <div id="compact-list-container" class="flex flex-col"></div>

                <!-- Salon Details Section (Location) -->
                <div>
                    <h3 class="text-[#1b0d18] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] pb-3">沙龍資訊</h3>
                    <div class="flex items-center gap-4 bg-white dark:bg-[#2d1a29] rounded-xl p-3 shadow-sm justify-between mb-6">
                        <div class="flex items-center gap-4">
                            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-lg size-14 shrink-0 salon-image" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCJMRVTW3ayRoqi5ZrDNrEovFo4AVMQISSN6ZuWwe6xw6hmS5YEIONmzOH1ncr7i7dDh_iof0v5X5WRcjuAN0tMFCavA2vcoYmndBrj6yLTM3jsKYa55-tO8FZPZixCPREULF2nKLCRRCzUHnXkWI9ryQ2srqn7bKRW0JZiX3UGRbJv1cMuBZ9te1hbe5pV8WZrfHsTiYNWgXiuomEkBZFztSsYWc3t7v2mtaez-GPYMsaGB1Rhq8nvJQuNYlDcPyaiNnEmySerDk-d");'></div>
                            <div class="flex flex-col justify-center">
                                <p class="text-[#1b0d18] dark:text-white text-base font-bold leading-normal line-clamp-1 salon-name">Pretty Salon</p>
                                <p class="text-primary/70 text-sm font-normal leading-normal line-clamp-2 salon-address">台北市信義區時尚大道123號</p>
                            </div>
                        </div>
                        <div class="shrink-0">
                            <button class="flex min-w-[48px] h-10 w-10 cursor-pointer items-center justify-center rounded-full bg-primary/10 text-primary">
                                <i class="fa-solid fa-location-arrow"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Booking Information Section (Merged into Hero Card) -->

                <!-- Bottom Buttons -->
                <div class="flex flex-col gap-3 mt-4 mb-4">
                    <button class="flex w-full cursor-pointer items-center justify-center rounded-full h-14 bg-primary text-white text-base font-bold transition-all hover:bg-opacity-90 active:scale-[0.98] btn-reschedule">
                        <span class="truncate">更改預約</span>
                    </button>
                    <button class="flex w-full cursor-pointer items-center justify-center rounded-full h-14 border border-gray-200 dark:border-gray-700 text-[#1b0d18] dark:text-white text-base font-medium transition-all hover:bg-gray-50 dark:hover:bg-white/5 active:scale-[0.98] btn-cancel">
                        <span class="truncate">取消預約</span>
                    </button>
                </div>
            </div>
        </template>

        <!-- Template for History Card -->
        <template id="history-card-template">
            <div class="flex flex-col items-stretch justify-start rounded-xl shadow-sm bg-white dark:bg-white/5 overflow-hidden border border-accent-soft/50 dark:border-white/5 mb-4 history-card">
                <div class="flex p-4 gap-4">
                    <div class="w-24 h-24 bg-center bg-no-repeat bg-cover rounded-lg shrink-0" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCMkStRV5clh0STCcvx_LWc9Vpp_VBOkSH_dWLFtqa_sDAyQmRXubyOk5l8Vr9e18QjvMAaGqZ3ete56yz2J5TaYDSUDg4KoVadJig1m9hZX9mtZ_Tz7BD4Qay9WaQ1SDOEQq7BWAt7zynSJ10s6c7SUeQHXA735GkRYttcb9hRiJw9MIkUMhNSGZP5mVphsrJmc82Hx5j-FDHlUzqU1I4UUEiSY488Pc0O_ES_tGYwo9q8VIcT7CFDgwb0dKscUUwvh3PxL2rhDn3O");'></div>
                    <div class="flex flex-1 flex-col justify-between">
                        <div>
                            <p class="text-[#1b0d18] dark:text-white text-lg font-bold leading-tight stylist-name">設計師名稱</p>
                            <p class="text-text-muted text-sm font-normal mt-1 service-info">一般服務 • YYYY-MM-DD</p>
                        </div>
                        <p class="text-primary text-base font-bold price-info">NT$ 500</p>
                    </div>
                </div>
                <div class="flex px-4 pb-4 gap-3">
                    <button class="flex-1 h-10 cursor-pointer items-center justify-center rounded-full bg-primary text-white text-sm font-bold shadow-md shadow-primary/20 btn-rebook">
                        <span>再次預約</span>
                    </button>
                    <button class="flex-1 h-10 cursor-pointer items-center justify-center rounded-full bg-accent-soft dark:bg-white/10 text-[#1b0d18] dark:text-white text-sm font-bold">
                        <span>評分與評論</span>
                    </button>
                </div>
            </div>
        </template>

    </div>

    <script>
        // LIFF ID (From previous context)
        // 優先從網址參數取得 LIFF ID (例如 ?liffId=xxx)，若無則使用預設值
        const urlParams = new URLSearchParams(window.location.search);
        // Default to the provided ID for Status Page
        const LIFF_ID = urlParams.get('liffId') || '2009027968-4BN6SYDY'; 
        console.log('Using LIFF ID:', LIFF_ID);
        let currentUserId = null; // Will be set after LIFF init
        let currentTab = 'upcoming';

        // Initialize LIFF
        window.onload = async function() {
            // Show skeleton for initial tab
            showSkeleton(currentTab);

            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                currentUserId = profile.userId;
                console.log('User ID:', currentUserId);
                
                // Fetch appointments
                fetchAppointments(currentTab);

            } catch (err) {
                console.error('LIFF Init Failed:', err);
                // Fallback for testing in browser without LIFF (optional)
                // currentUserId = 'U_TEST_USER'; 
                // fetchAppointments(currentTab);
                document.getElementById('loading-spinner').innerHTML = `<div class="px-4 text-center"><p class="text-red-500 font-bold mb-2">LIFF 初始化失敗</p><p class="text-xs text-gray-500 bg-gray-100 p-2 rounded text-left break-all">${err.message || JSON.stringify(err)}</p><p class="text-xs text-gray-400 mt-2">請確認此頁面網址是否已在 LINE Developers Console 註冊為 LIFF 應用程式，或者 Endpoint URL 是否正確。</p></div>`;
            }
        };

        // Handle Back Button
        function handleBack() {
            if (liff.isInClient()) {
                liff.closeWindow();
            } else {
                window.history.back();
            }
        }

        // Fetch Appointments
        async function fetchAppointments(type) {
            const container = document.getElementById('appointments-container');
            
            try {
                if (!currentUserId) {
                    // Try to get from URL for testing if not set
                    const urlParams = new URLSearchParams(window.location.search);
                    // For testing purposes allow user_id override or fallback
                    // But in prod strict LIFF flow is better. 
                    // Let's assume currentUserId is set by init.
                    console.warn('User ID not set yet');
                    return; 
                }

                const res = await fetch(`/api/get-appointments?user_id=${currentUserId}&type=${type}`);
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                
                renderAppointments(data, type);

            } catch (err) {
                console.error('Fetch Error:', err);
                container.innerHTML = `<p class="text-center text-gray-500 mt-10">無法載入預約資訊</p><p class="text-xs text-center text-gray-400">${err.message}</p>`;
            }
        }

        // Render Appointments
        function renderAppointments(appointments, type) {
            const container = document.getElementById('appointments-container');
            container.innerHTML = ''; // Clear loading spinner

            if (appointments.length === 0) {
                const emptyMsg = type === 'upcoming' ? '目前沒有即將到來的預約' : '目前沒有歷史預約紀錄';
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10 opacity-60">
                        <i class="fa-solid fa-calendar-xmark text-6xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500 text-sm">${emptyMsg}</p>
                    </div>
                `;
                return;
            }

            // For Status Page (Upcoming), we use the "Active Hero Card" style for the first one
            if (type === 'upcoming') {
                // 1. Render First Item (Hero Card)
                const appt = appointments[0]; 
                const template = document.getElementById('active-card-template');
                const clone = template.content.cloneNode(true);
                
                // Fill Stylist in the new "Assigned Professional" section
                clone.querySelector('.stylist-name').textContent = appt.stylist || '指定設計師';
                
                // Fill Service Name
                if(clone.querySelector('.booking-service')) {
                    clone.querySelector('.booking-service').textContent = appt.service || '一般服務';
                }

                // Fill Date/Time
                clone.querySelector('.date-text').textContent = appt.date;
                let timeDisplay = appt.time;
                if (appt.endTime) timeDisplay += ` - ${appt.endTime}`;
                clone.querySelector('.time-text').textContent = timeDisplay;

                // Buttons
                const cancelBtn = clone.querySelector('.btn-cancel');
                cancelBtn.onclick = () => handleCancel(appt.id);
                
                const rescheduleBtn = clone.querySelector('.btn-reschedule');
                rescheduleBtn.onclick = () => alert('請聯繫設計師進行更改'); 

                // 2. Render Subsequent Items (Compact List) - FILTERED
                const currentDay = appt.date;
                const laterAppointments = appointments.slice(1).filter(a => a.date === currentDay);

                const compactListContainer = clone.getElementById('compact-list-container');

                if (laterAppointments.length > 0) {
                     // Insert Title
                     const title = document.createElement('h6');
                     title.className = 'mt-4 mb-3 text-sm font-bold text-gray-400 uppercase tracking-wider px-1';
                     title.textContent = '今日稍後行程';
                     compactListContainer.appendChild(title);

                     // Loop through filtered appointments
                     laterAppointments.forEach(nextAppt => {
                         const card = document.createElement('div');
                         card.className = 'compact-appointment-card mb-3 cursor-pointer group';
                         card.onclick = () => {
                              if(confirm(`預約時間: ${nextAppt.time}\n要取消此預約嗎？`)) {
                                  handleCancel(nextAppt.id);
                              }
                         };

                         card.innerHTML = `
                            <div class="flex items-center gap-4 flex-1">
                                 <div class="flex flex-col items-center justify-center min-w-[60px] border-r border-gray-100 dark:border-white/10 pr-4">
                                     <i class="fa-regular fa-clock text-primary text-xs mb-1 group-hover:scale-110 transition-transform"></i>
                                     <span class="text-primary font-bold text-lg leading-none">${nextAppt.time}</span>
                                 </div>
                                 <div class="flex flex-col gap-1">
                                     <span class="text-[#1b0d18] dark:text-white font-bold text-sm line-clamp-1">${nextAppt.service || '一般服務'}</span>
                                     <div class="flex items-center gap-1.5">
                                         <div class="size-5 rounded-full bg-gray-200 bg-cover bg-center shadow-sm" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCL1YvZc9vWZJ9GiVuuWWM-av6u8YdeHm1Jgv8tYw8axrTwQq7ZR84wTe89nuC8A5dwR_oya7pRLN6xYwqXY8V-0NRIgWQ5hWQYbI9iVI30AvhTiRXo4NRXDFL5ZndEXlKm6RxxbKoZh000JC42yB5urx2De51L2d10BSBu_klGM0fcejTK5Q0QbbocZy6IOVWw3hV_fkczYRfPQpCjbbdHHyun9LGo16YDclE613E4Y6fLw_q4igKd9RsXCfy1sTzTNgW7Do_pC8u4");'></div>
                                         <span class="text-xs text-gray-500 font-medium">${nextAppt.stylist || '指定設計師'}</span>
                                     </div>
                                 </div>
                            </div>
                            <div class="pl-2">
                                 <div class="size-8 rounded-full bg-primary/5 text-primary flex items-center justify-center group-hover:bg-primary group-hover:text-white transition-colors">
                                     <i class="fa-solid fa-chevron-right text-xs"></i>
                                 </div>
                            </div>
                        `;
                        compactListContainer.appendChild(card);
                     });
                } else {
                    // Remove container if empty
                    if(compactListContainer) compactListContainer.remove();
                }

                // 3. Fetch Salon Info (Async update)
                const salonNameEl = clone.querySelector('.salon-name');
                const salonAddrEl = clone.querySelector('.salon-address');
                const salonImgEl = clone.querySelector('.salon-image');

                fetch('/api/get-salon-info')
                    .then(res => res.json())
                    .then(data => {
                        if(data.name && salonNameEl) salonNameEl.textContent = data.name;
                        if(data.address && salonAddrEl) salonAddrEl.textContent = data.address;
                        if(data.image_url && salonImgEl) salonImgEl.style.backgroundImage = `url("${data.image_url}")`;
                    })
                    .catch(e => console.error('Salon info load error', e));

                container.appendChild(clone);


            } else {
                // History Rendering
                const template = document.getElementById('history-card-template');
                if (!template) {
                    console.error('History card template not found');
                    return;
                }

                appointments.forEach(appt => {
                    const clone = template.content.cloneNode(true);
                    
                    clone.querySelector('.stylist-name').textContent = appt.stylist || '指定設計師';
                    
                    // Format Date
                    let timeDisplay = appt.time;
                    if (appt.endTime) {
                        timeDisplay += ` - ${appt.endTime}`;
                    }
                    clone.querySelector('.service-info').textContent = `一般服務 • ${appt.date} • ${timeDisplay}`;
                    
                    clone.querySelector('.price-info').textContent = `NT$ ${appt.price || 500}`;

                    // Rebook Button
                    const rebookBtn = clone.querySelector('.btn-rebook');
                    rebookBtn.onclick = () => {
                        // Redirect to booking
                        window.location.href = 'booking-liff.html';
                    };

                    container.appendChild(clone);
                });

                // End of list indicator
                const endIndicator = document.createElement('div');
                endIndicator.className = 'py-8 flex flex-col items-center justify-center text-gray-400 opacity-60';
                endIndicator.innerHTML = `
                    <i class="fa-solid fa-clock-rotate-left text-4xl mb-2"></i>
                    <p class="text-sm">已顯示所有紀錄</p>
                `;
                container.appendChild(endIndicator);
            }
        }

        function showSkeleton(type) {
            const container = document.getElementById('appointments-container');
            container.innerHTML = ''; // Clear existing content

            let templateId = type === 'upcoming' ? 'upcoming-skeleton-template' : 'history-skeleton-template';
            const template = document.getElementById(templateId);
            
            if (template) {
                const clone = template.content.cloneNode(true);
                container.appendChild(clone);
                
                // For history, add a few more to simulate a list
                if (type === 'history') {
                    container.appendChild(template.content.cloneNode(true));
                    container.appendChild(template.content.cloneNode(true));
                }
            }
        }

        function switchTab(tab) {
            if (currentTab === tab) return;
            currentTab = tab;
            
            // Update Tabs UI
            const tabs = ['upcoming', 'history'];
            tabs.forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                if (t === tab) {
                    el.classList.remove('tab-inactive');
                    el.classList.add('tab-active');
                } else {
                    el.classList.remove('tab-active');
                    el.classList.add('tab-inactive');
                }
            });

            // Toggle History Controls
            const historyControls = document.getElementById('history-controls');
            if (historyControls) {
                if (tab === 'history') {
                    historyControls.classList.remove('hidden');
                } else {
                    historyControls.classList.add('hidden');
                }
            }

            // Show Skeleton immediately
            showSkeleton(tab);

            // Fetch Data
            fetchAppointments(tab);
        }

        // Handle Cancel (Placeholder)
        function handleCancel(bookingId) {
            // Future: Call Cancel API
            if (confirm('確定要取消此預約嗎？\n(目前請直接聯繫店家取消)')) {
                // alert('請聯繫官方帳號進行取消。');
                // Or implement API call here
            }
        }
    </script>
</body>
</html>
