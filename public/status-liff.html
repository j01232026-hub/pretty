<!DOCTYPE html>
<html class="light" lang="zh-TW">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>我的預約</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#8A2BE2",
                        "background-light": "#f8f6f7",
                        "background-dark": "#22101d",
                        "accent-soft": "#f0e6fa", // Purple tint
                        "text-main": "#1b0d18",
                        "text-muted": "#6b7280"
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    },
                    borderRadius: {"DEFAULT": "1rem", "lg": "2rem", "xl": "3rem", "full": "9999px"},
                },
            },
        }
    </script>
    <style type="text/tailwindcss">
        body {
            min-height: max(884px, 100dvh);
        }
        .tab-active {
            @apply bg-white dark:bg-[#3d2a39] shadow-sm text-primary font-bold;
        }
        .tab-inactive {
            @apply text-gray-500 dark:text-gray-400 font-medium hover:text-primary/70;
        }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-[#1b0d18] dark:text-white">
    <div class="relative flex h-auto min-h-screen w-full flex-col max-w-md mx-auto overflow-x-hidden border-x border-gray-100 dark:border-gray-800 shadow-xl">
        <!-- Header -->
        <div class="flex items-center bg-background-light dark:bg-background-dark p-4 pb-2 justify-between sticky top-0 z-10">
            <div class="text-[#1b0d18] dark:text-white flex size-12 shrink-0 items-center cursor-pointer" onclick="handleBack()">
                <span class="material-symbols-outlined">arrow_back_ios</span>
            </div>
            <h2 class="text-[#1b0d18] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">我的預約</h2>
        </div>

        <!-- Tabs -->
        <div class="px-4 py-2 sticky top-14 z-10 bg-background-light dark:bg-background-dark">
            <div class="flex p-1 bg-gray-200/50 dark:bg-[#1b0d18] rounded-xl">
                <button id="tab-upcoming" class="flex-1 py-2 text-sm rounded-lg transition-all tab-active" onclick="switchTab('upcoming')">即將到來</button>
                <button id="tab-history" class="flex-1 py-2 text-sm rounded-lg transition-all tab-inactive" onclick="switchTab('history')">歷史紀錄</button>
            </div>
        </div>

        <!-- Content Container -->
        <div class="flex flex-col gap-6 p-4 pb-20 min-h-[500px]" id="appointments-container">
            <!-- Loading State -->
            <div id="loading-spinner" class="flex flex-col items-center justify-center py-10">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-primary"></div>
                <p class="mt-4 text-gray-500 text-sm">載入預約中...</p>
            </div>
            
            <!-- Dynamic content will be injected here -->
        </div>
        
        <!-- Template for Active Appointment (Hero Card) -->
        <template id="active-card-template">
            <div class="@container">
                <!-- Status Hero Card -->
                <div class="flex flex-col items-stretch justify-start rounded-xl shadow-[0_4px_12px_rgba(0,0,0,0.05)] bg-white dark:bg-[#2d1a29] overflow-hidden mb-6">
                    <!-- Gradient Status Header -->
                    <div class="w-full bg-center bg-no-repeat aspect-video bg-cover" style="background-image: linear-gradient(135deg, #fce7f3 0%, #f042c4 100%);">
                        <div class="flex flex-col h-full items-center justify-center text-white text-center p-6">
                            <span class="material-symbols-outlined text-5xl mb-2">check_circle</span>
                            <p class="text-3xl font-bold">已確認</p>
                        </div>
                    </div>
                    
                    <!-- Content Body -->
                    <div class="flex w-full min-w-72 grow flex-col items-stretch justify-center gap-1 py-4 px-6">
                        <p class="text-primary text-sm font-semibold uppercase tracking-wider">即將到來</p>
                        <p class="text-[#1b0d18] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em]">您的預約已準備就緒！</p>
                        
                        <div class="mt-4">
                            <div class="flex gap-6 justify-between mb-2">
                                <p class="text-[#1b0d18] dark:text-white text-base font-medium leading-normal">距離開始還有</p>
                                <p class="text-[#1b0d18] dark:text-white text-sm font-normal leading-normal countdown-text">計算中...</p>
                            </div>
                            <div class="rounded-full bg-primary/20"><div class="h-2 rounded-full bg-primary" style="width: 100%;"></div></div>
                            <p class="text-primary text-xs font-medium mt-2">期待您的光臨！</p>
                        </div>
                    </div>
                </div>

                <!-- Salon Details Section (Location) -->
                <div>
                    <h3 class="text-[#1b0d18] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] pb-3">沙龍資訊</h3>
                    <div class="flex items-center gap-4 bg-white dark:bg-[#2d1a29] rounded-xl p-3 shadow-sm justify-between mb-6">
                        <div class="flex items-center gap-4">
                            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-lg size-14 shrink-0" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCL1YvZc9vWZJ9GiVuuWWM-av6u8YdeHm1Jgv8tYw8axrTwQq7ZR84wTe89nuC8A5dwR_oya7pRLN6xYwqXY8V-0NRIgWQ5hWQYbI9iVI30AvhTiRXo4NRXDFL5ZndEXlKm6RxxbKoZh000JC42yB5urx2De51L2d10BSBu_klGM0fcejTK5Q0QbbocZy6IOVWw3hV_fkczYRfPQpCjbbdHHyun9LGo16YDclE613E4Y6fLw_q4igKd9RsXCfy1sTzTNgW7Do_pC8u4");'></div>
                            <div class="flex flex-col justify-center">
                                <p class="text-[#1b0d18] dark:text-white text-base font-bold leading-normal line-clamp-1">Pretty Salon</p>
                                <p class="text-primary/70 text-sm font-normal leading-normal line-clamp-2">台北市信義區時尚大道123號</p>
                            </div>
                        </div>
                        <div class="shrink-0">
                            <button class="flex min-w-[48px] h-10 w-10 cursor-pointer items-center justify-center rounded-full bg-primary/10 text-primary">
                                <span class="material-symbols-outlined">directions</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Booking Information Section -->
                <div>
                    <h3 class="text-[#1b0d18] dark:text-white text-lg font-bold leading-tight tracking-[-0.015em] pb-3">預約詳情</h3>
                    <div class="bg-white dark:bg-[#2d1a29] rounded-xl p-4 shadow-sm flex flex-col gap-4">
                        <div class="flex items-start justify-between">
                            <div class="flex flex-col">
                                <p class="text-xs text-primary font-bold uppercase">服務項目</p>
                                <p class="text-[#1b0d18] dark:text-white font-medium">一般服務</p>
                                <p class="text-sm text-gray-500">30 分鐘</p>
                            </div>
                            <div class="flex flex-col items-end">
                                <p class="text-xs text-primary font-bold uppercase text-right">時間</p>
                                <p class="text-[#1b0d18] dark:text-white font-medium text-right date-text">YYYY-MM-DD</p>
                                <p class="text-sm text-gray-500 text-right time-text">HH:MM</p>
                            </div>
                        </div>
                        <div class="h-px bg-gray-100 dark:bg-gray-700 w-full"></div>
                        
                        <!-- Assigned Professional (Stylist) -->
                        <div class="flex items-center gap-4">
                            <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-12" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCL1YvZc9vWZJ9GiVuuWWM-av6u8YdeHm1Jgv8tYw8axrTwQq7ZR84wTe89nuC8A5dwR_oya7pRLN6xYwqXY8V-0NRIgWQ5hWQYbI9iVI30AvhTiRXo4NRXDFL5ZndEXlKm6RxxbKoZh000JC42yB5urx2De51L2d10BSBu_klGM0fcejTK5Q0QbbocZy6IOVWw3hV_fkczYRfPQpCjbbdHHyun9LGo16YDclE613E4Y6fLw_q4igKd9RsXCfy1sTzTNgW7Do_pC8u4");'></div>
                            <div class="flex flex-col">
                                <p class="text-xs text-primary font-bold uppercase">指定設計師</p>
                                <p class="text-[#1b0d18] dark:text-white font-medium stylist-name">設計師名稱</p>
                                <div class="flex items-center gap-1">
                                    <span class="material-symbols-outlined text-yellow-500 text-sm fill-current">star</span>
                                    <p class="text-xs text-gray-500">5.0 專業設計師</p>
                                </div>
                            </div>
                            <button class="ml-auto flex h-9 w-9 items-center justify-center rounded-full bg-primary/10 text-primary">
                                <span class="material-symbols-outlined text-base">chat</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Bottom Buttons -->
                <div class="flex flex-col gap-3 mt-4 mb-4">
                    <button class="flex w-full cursor-pointer items-center justify-center rounded-full h-14 bg-primary text-white text-base font-bold transition-all hover:bg-opacity-90 active:scale-[0.98] btn-reschedule">
                        <span class="truncate">更改預約</span>
                    </button>
                    <button class="flex w-full cursor-pointer items-center justify-center rounded-full h-14 border border-gray-200 dark:border-gray-700 text-[#1b0d18] dark:text-white text-base font-medium transition-all hover:bg-gray-50 dark:hover:bg-white/5 active:scale-[0.98] btn-cancel">
                        <span class="truncate">取消預約</span>
                    </button>
                </div>
            </div>
        </template>

    </div>

    <script>
        // LIFF ID (From previous context)
        // 優先從網址參數取得 LIFF ID (例如 ?liffId=xxx)，若無則使用預設值
        const urlParams = new URLSearchParams(window.location.search);
        // Default to the provided ID for Status Page
        const LIFF_ID = urlParams.get('liffId') || '2009027968-4BN6SYDY'; 
        console.log('Using LIFF ID:', LIFF_ID);
        let currentUserId = null; // Will be set after LIFF init
        let currentTab = 'upcoming';

        // Initialize LIFF
        window.onload = async function() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                currentUserId = profile.userId;
                console.log('User ID:', currentUserId);
                
                // Fetch appointments
                fetchAppointments(currentTab);

            } catch (err) {
                console.error('LIFF Init Failed:', err);
                // Fallback for testing in browser without LIFF (optional)
                // currentUserId = 'U_TEST_USER'; 
                // fetchAppointments(currentTab);
                document.getElementById('loading-spinner').innerHTML = `<div class="px-4 text-center"><p class="text-red-500 font-bold mb-2">LIFF 初始化失敗</p><p class="text-xs text-gray-500 bg-gray-100 p-2 rounded text-left break-all">${err.message || JSON.stringify(err)}</p><p class="text-xs text-gray-400 mt-2">請確認此頁面網址是否已在 LINE Developers Console 註冊為 LIFF 應用程式，或者 Endpoint URL 是否正確。</p></div>`;
            }
        };

        // Handle Back Button
        function handleBack() {
            if (liff.isInClient()) {
                liff.closeWindow();
            } else {
                window.history.back();
            }
        }

        // Fetch Appointments
        async function fetchAppointments(type) {
            const container = document.getElementById('appointments-container');
            
            try {
                if (!currentUserId) {
                    // Try to get from URL for testing if not set
                    const urlParams = new URLSearchParams(window.location.search);
                    // For testing purposes allow user_id override or fallback
                    // But in prod strict LIFF flow is better. 
                    // Let's assume currentUserId is set by init.
                    console.warn('User ID not set yet');
                    return; 
                }

                const res = await fetch(`/api/get-appointments?user_id=${currentUserId}&type=${type}`);
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();
                
                renderAppointments(data, type);

            } catch (err) {
                console.error('Fetch Error:', err);
                container.innerHTML = `<p class="text-center text-gray-500 mt-10">無法載入預約資訊</p><p class="text-xs text-center text-gray-400">${err.message}</p>`;
            }
        }

        // Render Appointments
        function renderAppointments(appointments, type) {
            const container = document.getElementById('appointments-container');
            container.innerHTML = ''; // Clear loading spinner

            if (appointments.length === 0) {
                const emptyMsg = type === 'upcoming' ? '目前沒有即將到來的預約' : '目前沒有歷史預約紀錄';
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10 opacity-60">
                        <span class="material-symbols-outlined text-6xl text-gray-300 mb-4">event_busy</span>
                        <p class="text-gray-500 text-sm">${emptyMsg}</p>
                    </div>
                `;
                return;
            }

            // For Status Page (Upcoming), we use the "Active Hero Card" style for the first one
            if (type === 'upcoming') {
                const appt = appointments[0]; // Take the first one as active
                const template = document.getElementById('active-card-template');
                const clone = template.content.cloneNode(true);
                
                // Fill Stylist in the new "Assigned Professional" section
                clone.querySelector('.stylist-name').textContent = appt.stylist || '指定設計師';
                
                // Fill Date/Time
                clone.querySelector('.date-text').textContent = appt.date;
                let timeDisplay = appt.time;
                if (appt.endTime) timeDisplay += ` - ${appt.endTime}`;
                clone.querySelector('.time-text').textContent = timeDisplay;
                
                // Countdown logic (Simple approximation)
                const apptDate = new Date(`${appt.date}T${appt.time}`);
                const now = new Date();
                const diffMs = apptDate - now;
                const diffHrs = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffHrs / 24);
                
                let countdownText = "";
                if (diffDays > 0) countdownText = `${diffDays} 天`;
                else if (diffHrs > 0) countdownText = `${diffHrs} 小時`;
                else countdownText = "即將開始";
                
                clone.querySelector('.countdown-text').textContent = countdownText;

                // Buttons
                const cancelBtn = clone.querySelector('.btn-cancel');
                cancelBtn.onclick = () => handleCancel(appt.id);
                
                const rescheduleBtn = clone.querySelector('.btn-reschedule');
                rescheduleBtn.onclick = () => alert('請聯繫設計師進行更改'); // Placeholder

                container.appendChild(clone);
            } else {
                // History Rendering
                const template = document.getElementById('history-card-template');
                if (!template) {
                    console.error('History card template not found');
                    return;
                }

                appointments.forEach(appt => {
                    const clone = template.content.cloneNode(true);
                    
                    clone.querySelector('.stylist-name').textContent = appt.stylist || '指定設計師';
                    
                    // Format Date
                    let timeDisplay = appt.time;
                    if (appt.endTime) {
                        timeDisplay += ` - ${appt.endTime}`;
                    }
                    clone.querySelector('.service-info').textContent = `一般服務 • ${appt.date} • ${timeDisplay}`;
                    
                    clone.querySelector('.price-info').textContent = `NT$ ${appt.price || 500}`;

                    // Rebook Button
                    const rebookBtn = clone.querySelector('.btn-rebook');
                    rebookBtn.onclick = () => {
                        // Redirect to booking
                        window.location.href = 'booking-liff.html';
                    };

                    container.appendChild(clone);
                });

                // End of list indicator
                const endIndicator = document.createElement('div');
                endIndicator.className = 'py-8 flex flex-col items-center justify-center text-gray-400 opacity-60';
                endIndicator.innerHTML = `
                    <span class="material-symbols-outlined text-4xl mb-2">history</span>
                    <p class="text-sm">已顯示所有紀錄</p>
                `;
                container.appendChild(endIndicator);
            }
        }

        function switchTab(tab) {
            if (currentTab === tab) return;
            currentTab = tab;
            
            // Update Tabs UI
            const tabs = ['upcoming', 'history'];
            tabs.forEach(t => {
                const el = document.getElementById(`tab-${t}`);
                if (t === tab) {
                    el.classList.remove('tab-inactive');
                    el.classList.add('tab-active');
                } else {
                    el.classList.remove('tab-active');
                    el.classList.add('tab-inactive');
                }
            });

            // Toggle History Controls
            const historyControls = document.getElementById('history-controls');
            if (historyControls) {
                if (tab === 'history') {
                    historyControls.classList.remove('hidden');
                } else {
                    historyControls.classList.add('hidden');
                }
            }

            // Fetch Data
            fetchAppointments(tab);
        }

        // Handle Cancel (Placeholder)
        function handleCancel(bookingId) {
            // Future: Call Cancel API
            if (confirm('確定要取消此預約嗎？\n(目前請直接聯繫店家取消)')) {
                // alert('請聯繫官方帳號進行取消。');
                // Or implement API call here
            }
        }
    </script>
</body>
</html>
