<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
    <title>客服對話</title>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LIFF SDK -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <!-- Supabase JS Client (for Realtime) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Global Error Handler for Mobile Debugging
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            alert('System Error: ' + msg + '\nLine: ' + lineNo);
            // Also log to our custom debug console
            if (typeof log === 'function') {
                log('Global Error: ' + msg, 'error');
            }
            return false;
        };

        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#8A2BE2",
                        "chat-bg": "#9bb7d4", // LINE-like background
                        "bubble-me": "#9de694", // LINE-like green bubble
                        "bubble-other": "#ffffff",
                    },
                    fontFamily: {
                        "display": ["Manrope", "sans-serif"]
                    }
                },
            },
        }
    </script>
    <script>
        // Global Back Handler (Defined in Head for Safety)
        function handleBack() {
            try {
                if (typeof liff !== 'undefined' && liff.isInClient()) {
                    liff.closeWindow();
                }
            } catch (e) {
                console.error(e);
            }
            // Fallback
            window.history.back();
            setTimeout(function() {
                window.location.href = 'status-liff.html';
            }, 300);
        }
    </script>
    <style>
        /* Fallback colors if Tailwind fails */
        :root {
            --chat-bg: #9bb7d4;
            --primary: #f042c4;
        }
        body {
            background-color: var(--chat-bg);
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            margin: 0;
        }
        /* Custom Scrollbar */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        /* Debug Console */
        #debug-console {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100px;
            background: rgba(0,0,0,0.8);
            color: lime;
            font-family: monospace;
            font-size: 10px;
            overflow-y: auto;
            z-index: 9999;
            padding: 5px;
            display: none; /* Hidden by default */
            pointer-events: none;
        }
    </style>
</head>
<body class="font-display text-[#1b0d18] bg-[#9bb7d4]">
    <div id="debug-console"></div>

    <!-- Main Container -->
    <div class="flex flex-col h-full w-full max-w-md mx-auto bg-[#9bb7d4] relative shadow-xl overflow-hidden">
        <!-- Header -->
        <div class="flex items-center bg-[#f8f6f7] p-4 pb-2 justify-between sticky top-0 z-50 shadow-sm shrink-0">
            <button id="back-btn" class="flex size-12 shrink-0 items-center justify-center cursor-pointer text-[#1b0d18] z-[100] relative bg-transparent border-none outline-none" onclick="handleBack()" ontouchstart="handleBack()">
                <span class="material-symbols-outlined">arrow_back_ios</span>
            </button>
            <h2 class="text-[#1b0d18] text-lg font-bold leading-tight flex-1 text-center pr-12">Pretty Salon 客服 <span class="text-xs text-gray-400 font-normal">(v1.9)</span></h2>
        </div>

        <!-- Chat Area -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3 pb-24 w-full">
            <!-- Messages will be injected here -->
            
            <!-- Loading Spinner -->
            <div id="loading-spinner" class="flex justify-center py-4">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
            </div>
            
            <!-- Error Message Container -->
            <div id="error-container" class="hidden flex-col items-center justify-center py-4 bg-red-100 rounded-lg p-4 mx-4 mt-4">
                <p class="text-red-600 font-bold mb-1">發生錯誤</p>
                <p class="text-xs text-red-500 break-all" id="error-text"></p>
            </div>
        </div>

        <!-- Input Area -->
        <div class="absolute bottom-0 left-0 w-full bg-[#f8f6f7] p-2 border-t border-gray-200 flex items-center gap-2 z-20 safe-area-bottom shrink-0">
            <button class="p-2 text-gray-500 rounded-full hover:bg-gray-200 flex items-center justify-center">
                <span class="material-symbols-outlined">add</span>
            </button>
            <div class="flex-1 bg-white rounded-2xl min-h-[40px] max-h-[120px] py-2 px-4 flex items-center">
                <textarea id="message-input" rows="1" class="w-full bg-transparent border-none focus:ring-0 outline-none p-0 resize-none max-h-[100px] text-base" placeholder="輸入訊息..." style="outline: none !important; box-shadow: none !important; -webkit-tap-highlight-color: transparent;"></textarea>
            </div>
            <button id="send-btn" class="p-2 text-[#9d2bee] rounded-full hover:bg-gray-200 disabled:opacity-50 focus:outline-none flex items-center justify-center" onclick="sendMessage()">
                <span class="material-symbols-outlined text-2xl fill-1">send</span>
            </button>
        </div>
    </div>

    <script>
        // Custom Logger for Mobile Debugging
        function log(msg, type = 'info') {
            console.log(msg);
            const debugConsole = document.getElementById('debug-console');
            if (debugConsole && debugConsole.style.display !== 'none') {
                const line = document.createElement('div');
                line.textContent = `[${type}] ${typeof msg === 'object' ? JSON.stringify(msg) : msg}`;
                line.style.color = type === 'error' ? 'red' : 'lime';
                debugConsole.appendChild(line);
                debugConsole.scrollTop = debugConsole.scrollHeight;
            }
        }
        
        // Show debug console if ?debug=true
        if (new URLSearchParams(window.location.search).get('debug') === 'true') {
            document.getElementById('debug-console').style.display = 'block';
        }

        // Error Display Helper
        function showError(msg) {
            document.getElementById('loading-spinner').style.display = 'none';
            const errContainer = document.getElementById('error-container');
            const errText = document.getElementById('error-text');
            errContainer.classList.remove('hidden');
            errContainer.classList.add('flex');
            errText.textContent = msg;
            log(msg, 'error');
        }

        // LIFF ID Configuration
        const urlParams = new URLSearchParams(window.location.search);
        // Default to History LIFF ID if not provided, to ensure init success
        const LIFF_ID = urlParams.get('liffId') || '2009027968-8FTFYHCQ'; 

        let currentUserId = null;
        let supabase = null;

        // Initialize
        // Use window.onload to match history-liff.html behavior
        window.onload = async function() {
            const spinner = document.getElementById('loading-spinner');
            const chatContainer = document.getElementById('chat-container');

            // Set a global timeout to avoid infinite spinning
            const initTimeout = setTimeout(() => {
                if (spinner.style.display !== 'none') {
                    showError('初始化逾時 (5s)，請檢查網路或 LIFF ID');
                    // Force remove spinner even if showError fails
                    spinner.style.setProperty('display', 'none', 'important');
                    spinner.classList.add('hidden');
                }
            }, 5000); 

            try {
                // 1. Initialize LIFF
                log('Initializing LIFF...');
                
                // Direct init without Promise.race to avoid premature timeout
                await liff.init({ liffId: LIFF_ID });
                
                log('LIFF Initialized');

                if (!liff.isLoggedIn()) {
                    log('User not logged in, calling login...');
                    liff.login();
                    return; // Stop here, login will redirect
                }
                const profile = await liff.getProfile();
                currentUserId = profile.userId;
                log('User ID: ' + currentUserId);

                // 2. Fetch Config for Supabase
                log('Fetching config...');
                const configRes = await fetch('/api/config');
                if (!configRes.ok) throw new Error('Config API Failed: ' + configRes.status);
                const config = await configRes.json();
                
                // 3. Init Supabase
                log('Initializing Supabase...');
                supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseKey);

                // 4. Load Messages
                log('Loading messages...');
                await loadHistory();

                // 5. Setup Realtime Subscription
                log('Setting up realtime...');
                subscribeRealtime();

                // Setup Textarea Auto-resize
                const textarea = document.getElementById('message-input');
                textarea.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                    // Enable/Disable send button
                    document.getElementById('send-btn').disabled = !this.value.trim();
                });

            } catch (err) {
                console.error('Init Error:', err);
                showError(err.message || '初始化失敗，請稍後再試');
            } finally {
                // Ensure spinner is removed in ANY case (success or error)
                clearTimeout(initTimeout);
                if (spinner) {
                    spinner.style.setProperty('display', 'none', 'important');
                    spinner.classList.add('hidden');
                }
                if (chatContainer) {
                    chatContainer.classList.remove('hidden');
                }
            }
        };

        // Initialize Supabase
        async function initSupabase() {
            try {
                const res = await fetch('/api/config');
                const config = await res.json();
                
                if (window.supabase) {
                    supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseKey);
                    console.log('Supabase Initialized');
                } else {
                    console.error('Supabase SDK not loaded');
                }
            } catch (err) {
                console.error('Failed to load Supabase config:', err);
            }
        }

        // Load History
        async function loadHistory() {
            const container = document.getElementById('chat-container');
            const spinner = document.getElementById('loading-spinner');
            
            try {
                const res = await fetch(`/api/get-messages?user_id=${currentUserId}`);
                if (!res.ok) throw new Error('API Error');
                const messages = await res.json();
                
                spinner.remove(); // Remove spinner

                messages.forEach(msg => {
                    appendMessage(msg, false); // false = don't scroll smoothly for history (jump to bottom at end)
                });
                
                scrollToBottom(false);

            } catch (err) {
                console.error('Load History Error:', err);
                spinner.innerHTML = `<p class="text-xs text-red-500">無法載入訊息</p>`;
            }
        }

        // Subscribe Realtime
        function subscribeRealtime() {
            if (!supabase) return;

            supabase.channel('public:messages')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
                    const newMsg = payload.new;
                    console.log('New Message:', newMsg);

                    // Check if message is relevant to current user
                    if (newMsg.sender_id === currentUserId || newMsg.receiver_id === currentUserId) {
                        appendMessage(newMsg, true);
                    }
                })
                .subscribe();
        }

        // Send Message
        async function sendMessage() {
            let content = '';
            let input = null;
            
            try {
                input = document.getElementById('message-input');
                if (!input) {
                    alert('系統錯誤: 找不到輸入框');
                    return;
                }
                content = input.value.trim();
                
                if (!currentUserId) {
                    alert('系統尚未初始化完成 (User ID missing)，請稍後再試');
                    return;
                }
                
                if (!content) return;

                // Clear input immediately for better UX
                input.value = '';
                input.style.height = 'auto';
                document.getElementById('send-btn').disabled = true;

                const res = await fetch('/api/send-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: content,
                        sender_id: currentUserId,
                        receiver_id: 'ADMIN'
                    })
                });

                if (!res.ok) {
                    const errData = await res.json();
                    throw new Error(errData.error || 'Send Failed');
                }
                
                // Optimistically append message to UI
                const tempMsg = {
                    content: content,
                    sender_id: currentUserId,
                    created_at: new Date().toISOString()
                };
                appendMessage(tempMsg, true);

            } catch (err) {
                console.error('Send Error:', err);
                alert('訊息發送失敗: ' + err.message);
                if (input && content) input.value = content; // Restore content
                document.getElementById('send-btn').disabled = false;
            }
        }

        // Append Message to UI
        function appendMessage(msg, smoothScroll = true) {
            const container = document.getElementById('chat-container');
            const isMe = msg.sender_id === currentUserId;
            
            const div = document.createElement('div');
            div.className = `flex w-full mb-4 ${isMe ? 'justify-end' : 'justify-start'}`;
            
            // Time formatting
            const time = new Date(msg.created_at).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });

            if (isMe) {
                // My Message (Right)
                div.innerHTML = `
                    <div class="flex flex-col items-end max-w-[75%]">
                        <div class="bg-[#9de694] text-black px-4 py-2 rounded-2xl rounded-tr-none shadow-sm break-words text-sm relative">
                            ${escapeHtml(msg.content)}
                        </div>
                        <span class="text-[10px] text-gray-500 mt-1 mr-1">${time}</span>
                    </div>
                `;
            } else {
                // Other Message (Left) - Assume Admin/Stylist
                div.innerHTML = `
                    <div class="flex items-start max-w-[85%]">
                        <div class="w-8 h-8 rounded-full bg-white mr-2 flex items-center justify-center shrink-0 border border-gray-200">
                            <span class="material-symbols-outlined text-gray-400 text-lg">support_agent</span>
                        </div>
                        <div class="flex flex-col items-start">
                            <span class="text-[10px] text-gray-600 mb-1 ml-1">Pretty Salon 客服</span>
                            <div class="bg-white text-black px-4 py-2 rounded-2xl rounded-tl-none shadow-sm break-words text-sm">
                                ${escapeHtml(msg.content)}
                            </div>
                            <span class="text-[10px] text-gray-500 mt-1 ml-1">${time}</span>
                        </div>
                    </div>
                `;
            }

            container.appendChild(div);
            scrollToBottom(smoothScroll);
        }

        function scrollToBottom(smooth = true) {
            const container = document.getElementById('chat-container');
            container.scrollTo({
                top: container.scrollHeight,
                behavior: smooth ? 'smooth' : 'auto'
            });
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }
    </script>
    <script>
        // Force remove spinner after 5 seconds globally to prevent infinite hanging
        setTimeout(() => {
            const s = document.getElementById('loading-spinner');
            if (s && s.style.display !== 'none') {
                console.warn('Force removing spinner due to timeout');
                s.style.setProperty('display', 'none', 'important');
                s.classList.add('hidden');
                document.getElementById('chat-container')?.classList.remove('hidden');
            }
        }, 5000);
    </script>
</body>
</html>
